@using SSDI.RequestMonitoring.UI.JComponents.Cards
@using SSDI.RequestMonitoring.UI.Models.Requests.JobOrder

<!-- Approval Process Tab -->
<Details__Card>
    <DetailsRow__Card Label="Approval History" FullRow="true">
        <div class="approval-header">
            <div class="approval-header__info">
                <i class="bi bi-clock-history"></i>
                <span>Showing @GetSortedApprovals().Count approval actions</span>
            </div>
            <div class="approval-sort">
                <label class="approval-sort__label">Sort by:</label>
                <button class="btn btn--outline btn--sm @(SortOrder == "desc" ? "approval-sort__button--active" : "")"
                        @onclick="@(() => SetSortOrder("desc"))"
                        title="Show newest first">
                    <i class="bi bi-sort-down"></i>
                    Newest First
                </button>
                <button class="btn btn--outline btn--sm @(SortOrder == "asc" ? "approval-sort__button--active" : "")"
                        @onclick="@(() => SetSortOrder("asc"))"
                        title="Show oldest first">
                    <i class="bi bi-sort-up"></i>
                    Oldest First
                </button>
            </div>
        </div>
    </DetailsRow__Card>

    @if (Request.Approvals?.Any() == true)
    {
        var sortedApprovals = GetSortedApprovals();

        @foreach (var approval in sortedApprovals)
        {
            <DetailsRow__Card FullRow="true">
                <div class="approval-step @GetApprovalStepClass(approval)">
                    <div class="approval-step__icon">
                        @if (approval.IsApproved)
                        {
                            <i class="bi bi-check-circle-fill"></i>
                        }
                        else if (approval.IsRejected)
                        {
                            <i class="bi bi-x-circle-fill"></i>
                        }
                        else if (approval.IsCancelled)
                        {
                            <i class="bi bi-slash-circle-fill"></i>
                        }
                        else
                        {
                            <i class="bi bi-clock"></i>
                        }
                    </div>
                    <div class="approval-step__content">
                        <div class="approval-step__header">
                            <div class="approval-step__subheader">
                                <span class="approval-step__stage">@utils.GetApprovalStagesDisplay(approval.Stage)</span>

                                <!-- Show iteration number if there are multiple actions at same stage -->
                                @if (HasMultipleActionsAtStage(approval.Stage))
                                {
                                    <div class="approval-step__iteration">
                                        <i class="bi bi-arrow-repeat"></i>
                                        Attempt #@GetActionIteration(approval)
                                    </div>
                                }
                            </div>
                            <span class="approval-step__status @GetApprovalStatusClass(approval)">
                                @utils.GetApprovalStatusText(approval)
                            </span>
                        </div>
                        <div class="approval-step__approver">
                            @utils.GetApprovalByText(approval): @(approval.ApproverName ?? $"User #{approval.ApproverId}")
                        </div>

                        @if (approval.ActionDate.HasValue)
                        {
                            <div class="approval-step__date">
                                @approval.ActionDate.Value.ToString("MMM dd, yyyy 'at' hh:mm tt")
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(approval.Remarks))
                        {
                            <div class="approval-step__remarks">
                                <strong>Remarks:</strong> @approval.Remarks
                            </div>
                        }

                    </div>
                </div>
            </DetailsRow__Card>
        }
    }
    else
    {
        <DetailsRow__Card FullRow="true">
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h3>No Approvals Yet</h3>
                <p>The approval process hasn't started for this request.</p>
            </div>
        </DetailsRow__Card>
    }
</Details__Card>

@code {
    [Parameter] public Job_OrderVM Request { get; set; } = new();

    private string SortOrder { get; set; } = "desc"; // "asc" or "desc"

    private List<Job_Order_ApprovalVM> GetSortedApprovals()
    {
        if (Request.Approvals == null || !Request.Approvals.Any())
            return new List<Job_Order_ApprovalVM>();

        var approvals = Request.Approvals.ToList();

        return SortOrder == "desc"
            ? approvals.OrderByDescending(a => a.ActionDate).ToList()
            : approvals.OrderBy(a => a.ActionDate).ToList();
    }

    private void SetSortOrder(string order)
    {
        SortOrder = order;
        StateHasChanged();
    }

    private bool HasMultipleActionsAtStage(ApprovalStage stage)
    {
        return Request.Approvals?.Count(a => a.Stage == stage) > 1;
    }

    private int GetActionIteration(Job_Order_ApprovalVM approval)
    {
        var stageApprovals = Request.Approvals?
            .Where(a => a.Stage == approval.Stage)
            .OrderBy(a => a.ActionDate)
            .ToList();

        if (stageApprovals == null) return 1;

        var index = stageApprovals.FindIndex(a => a.Id == approval.Id);
        return index + 1; // Convert from 0-based to 1-based
    }

    private string GetApprovalStepClass(Job_Order_ApprovalVM approval)
    {
        return approval.IsApproved ? "approval-step--approved" :
               approval.IsRejected ? "approval-step--rejected" :
               approval.IsCancelled ? "approval-step--cancelled" :
               "approval-step--pending";
    }

    private string GetApprovalStatusClass(Job_Order_ApprovalVM approval)
    {
        return approval.IsApproved ? "status-approved" :
               approval.IsRejected ? "status-rejected" :
               approval.IsCancelled ? "status-cancelled" :
               "status-pending";
    }
}