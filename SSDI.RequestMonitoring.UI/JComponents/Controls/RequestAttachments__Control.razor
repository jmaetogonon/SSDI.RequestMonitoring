@using SSDI.RequestMonitoring.UI.Contracts.Requests
@using SSDI.RequestMonitoring.UI.JComponents.Cards
@using SSDI.RequestMonitoring.UI.JComponents.Loading
@using SSDI.RequestMonitoring.UI.JComponents.Modals
@using SSDI.RequestMonitoring.UI.Models.Requests
@inject IPurchaseRequestSvc purchaseRequestSvc
@inject IPRAttachSvc attachSvc
@inject IJSRuntime JS
@implements IAsyncDisposable

<Details__Card>
    <DetailsRow__Card Label="Supporting Documents" FullRow="true">
        <div class="attachments-header">
            <div class="attachments-stats">
                <i class="bi bi-paperclip"></i>
                <span>@Request.Attachments.Where(x=>x.AttachType == RequestAttachType.Request).Count() files attached</span>
                @if (isDownloadingAll)
                {
                    <span class="download-progress">(@currentDownloadIndex/@Request.Attachments.Where(x => x.AttachType == RequestAttachType.Request).Count())</span>
                }
            </div>

            <div class="attachment-header-actions">
                @if ((Request?.Status == RequestStatus.Draft || Request?.Status == RequestStatus.Rejected) && ReportType == "Department")
                {
                    <div class="attachment-add">
                        <label for="file-upload-add" class="btn btn--primary btn--sm" title="Add attachment">
                            <i class="bi bi-plus-lg"></i>
                            <span>Upload</span>
                        </label>

                        <InputFile id="file-upload-add"
                                   multiple
                                   OnChange="OnFilesSelected" style="display: none;" />
                    </div>
                }

                <button class="btn btn--outline btn--sm"
                        @onclick="DownloadAll"
                        title="Download all files"
                        disabled="@isDownloadingAll">
                    @if (isDownloadingAll)
                    {
                        <i class="bi bi-arrow-repeat spinning"></i>
                        <span>Downloading...</span>
                    }
                    else
                    {
                        <i class="bi bi-download"></i>
                        <span>Download All</span>
                    }
                </button>
            </div>
        </div>
    </DetailsRow__Card>

    @if (Request.Attachments.Where(x => x.AttachType == RequestAttachType.Request)?.Any() == true)
    {
        <div class="attachments-grid">
            @foreach (var attachment in Request.Attachments.Where(x => x.AttachType == RequestAttachType.Request))
            {
                var isDownloadingThis = (downloadingAttachments.Contains(attachment.Id.ToString()));
                var isLoadingPreview = (loadingPreviewId == attachment.Id.ToString());

                <div class="attachment-card" @onclick="() => ViewAttachment(attachment)" title="Click to view">
                    <div class="attachment-card__icon">
                        @if (isLoadingPreview)
                        {
                            <div class="attachment-loading-spinner"></div>
                        }
                        else
                        {
                            <i class="@GetFileIcon(attachment.FileName)"></i>
                        }
                    </div>
                    <div class="attachment-card__content">
                        <div class="attachment-card__name">@attachment.FileName</div>
                        <div class="attachment-card__meta">
                            <span class="attachment-card__size">@FormatFileSize(attachment.Size)</span>
                            <span class="attachment-card__date">@attachment.DateCreated?.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>
                    <div class="attachment-card__actions">
                        <button class="attachment-card__btn"
                                @onclick="(e) => DownloadAttachment(attachment, e)"
                                @onclick:stopPropagation="true"
                                title="Download"
                                disabled="@isDownloadingThis">
                            @if (isDownloadingThis)
                            {
                                <i class="bi bi-arrow-repeat spinning"></i>
                            }
                            else
                            {
                                <i class="bi bi-download"></i>
                            }
                        </button>
                        @if ((Request?.Status == RequestStatus.Draft || Request?.Status == RequestStatus.Rejected) && ReportType == "Department")
                        {
                            <button class="attachment-card__btn"
                                    @onclick="(e) => DeleteAttachment(attachment, e)"
                                    @onclick:stopPropagation="true"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <DetailsRow__Card FullRow="true">
            <div class="attachments-empty">
                <i class="bi bi-folder-x"></i>
                <h3>No Attachments</h3>
                <p>No supporting documents have been uploaded for this request.</p>
            </div>
        </DetailsRow__Card>
    }
</Details__Card>

<!-- Attachment Preview Modal -->
@if (selectedAttachment != null)
{
    <div class="attachment-preview-modal @(showPreview ? "attachment-preview-modal--visible" : "")">
        <div class="attachment-preview-modal__overlay" @onclick="ClosePreview"></div>
        <div class="attachment-preview-modal__content">
            <div class="attachment-preview-modal__header">
                <h3>@selectedAttachment.FileName</h3>
                <button class="attachment-preview-modal__close" @onclick="ClosePreview">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="attachment-preview-modal__body">
                @if (isLoadingPreview)
                {
                    <LoadingScreen IsVisible="true" Text="Loading preview..." />
                }
                else if (IsImage(selectedAttachment.FileName))
                {
                    <div class="preview-image-container">
                        <img src="@previewUrl" alt="@selectedAttachment.FileName" class="preview-image" />
                        <div class="preview-controls">
                            <button class="preview-controls__btn" @onclick="() => DownloadAttachment(selectedAttachment)">
                                <i class="bi bi-download"></i>
                                Download Image
                            </button>
                            <button class="preview-controls__btn preview-controls__btn--outline" @onclick="ClosePreview">
                                <i class="bi bi-x"></i>
                                Close
                            </button>
                        </div>
                    </div>
                }
                else if (IsPdf(selectedAttachment.FileName))
                {
                    <object data="@previewUrl" type="application/pdf" class="pdf-preview">
                        <div class="pdf-fallback">
                            <i class="bi bi-file-pdf"></i>
                            <h4>PDF Preview Not Available</h4>
                            <p>Your browser doesn't support embedded PDF preview.</p>
                            <button class="btn btn--primary" @onclick="() => DownloadAttachment(selectedAttachment)">
                                <i class="bi bi-download"></i>
                                Download PDF
                            </button>
                        </div>
                    </object>
                }
                else
                {
                    <div class="attachment-preview__generic">
                        <div class="generic-icon-container">
                            <i class="@GetFileIcon(selectedAttachment.FileName)"></i>
                        </div>
                        <div class="generic-info">
                            <h4>@selectedAttachment.FileName</h4>
                            <p>Preview not available for this file type.</p>
                        </div>
                        <div class="generic-actions">
                            <button class="generic-actions__btn" @onclick="() => DownloadAttachment(selectedAttachment)">
                                <i class="bi bi-download"></i>
                                Download File
                            </button>
                            <button class="generic-actions__btn generic-actions__btn--outline" @onclick="ClosePreview">
                                <i class="bi bi-x"></i>
                                Close
                            </button>
                        </div>
                    </div>

                }
            </div>
        </div>
    </div>
}