@using SSDI.RequestMonitoring.UI.Models.Enums
@using SSDI.RequestMonitoring.UI.Models.Common

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="request-status-insight @CssClass">
        <i class="bi @Icon"></i>
        <span>@Message</span>
    </div>
}

@code {
    [Parameter] public IRequestDetailVM Request { get; set; } = default!;
    [Parameter] public string ReportType { get; set; } = "Unknown";
    [Parameter] public DateTime? AwaitingApprovalDate { get; set; }

    private string Message = string.Empty;
    private string CssClass = "info";
    private string Icon = "bi-info-circle";

    protected override void OnParametersSet()
    {
        BuildMessage();
    }

    private void BuildMessage()
    {
        if (Request == null) return;

        // ============================
        // CLOSED REQUEST
        // ============================
        if (Request.Status == RequestStatus.Closed && Request.DateCompleted.HasValue)
        {
            var completedDate = Request.DateCompleted.Value;
            var daysToComplete = (completedDate.Date - Request.DateCreated)!.Value.Days;

            Message = daysToComplete <= 0
              ? $"Completed today on {completedDate:MMM d}."
              : $"Completed in {FormatDaysSimple(daysToComplete)} on {completedDate:MMM d}.";

            CssClass = "success";
            Icon = "bi-check-circle";
            return;
        }


        // ============================
        // CANCELLED
        // ============================
        if (Request.Status == RequestStatus.Cancelled)
        {
            var action = Request.ApprovalsBase
                .Where(a => a.Action == ApprovalAction.Cancel && a.ActionDate.HasValue)
                .OrderByDescending(a => a.ActionDate)
                .FirstOrDefault();

            if (action?.ActionDate != null)
            {
                var cancelledDate = action.ActionDate.Value;
                var daysToCancel = (cancelledDate.Date - Request.DateCreated)!.Value.Days;

                Message = daysToCancel <= 0
                    ? $"Cancelled today on {cancelledDate:MMM d}."
                    : $"Cancelled in {FormatDaysSimple(daysToCancel)} on {cancelledDate:MMM d}.";
            }
            else
            {
                Message = "This request was cancelled.";
            }

            CssClass = "muted";
            Icon = "bi-x-circle";
            return;
        }


        // ============================
        // AWAITING APPROVAL
        // ============================
        if (AwaitingApprovalDate.HasValue)
        {
            var daysAgo = (DateTime.Now.Date - AwaitingApprovalDate.Value.Date).Days;

            if (Request.Status == RequestStatus.Rejected)
            {
                Message = $"Rejected {FormatDaysAgo(daysAgo)}.";
            }
            else
            {
                Message = $"Awaiting your approval for {FormatDaysAgo(daysAgo)}.";

                if (currentUser.IsAdmin && Request?.Status == RequestStatus.ForRequisition)
                {
                    Message = $"Requisition in progress for {FormatDaysSimple(daysAgo)}.";
                }
            }

            CssClass = GetSeverity(DateTime.Now.Date - AwaitingApprovalDate.Value.Date);
            Icon = "bi-hourglass-split";
            return;
        }

        // ============================
        // PENDING APPROVAL
        // ============================
        var pendingSince = CalculatePendingSince();

        if (pendingSince.HasValue)
        {
            var daysAgo = (DateTime.Now.Date - pendingSince.Value.Date).Days;

            if (currentUser.IsUser || Request?.RequestedById == currentUser.UserId)
            {
                Message = $"Submitted {FormatDaysAgo(daysAgo)}.";
            }
            else
            {
                Message = $"In progress for {FormatDaysAgo(daysAgo)} since your approval.";
            }

            CssClass = GetSeverity(DateTime.Now.Date - pendingSince.Value.Date);
            Icon = "bi-hourglass-split";
            return;
        }
    }

    // ============================
    // HELPERS
    // ============================
    private static string FormatDuration(int value, string unit)
    {
        return value == 1 ? $"1 {unit}" : $"{value} {unit}s";
    }
    private static string FormatDaysAgo(int days)
    {
        if (days <= 0) return "today";
        if (days == 1) return "yesterday";
        if (days < 7) return $"{FormatDuration(days, "day")} ago";
        if (days < 30) return $"{FormatDuration(days / 7, "week")} ago";
        if (days < 365) return $"{FormatDuration(days / 30, "month")} ago";
        return $"{FormatDuration(days / 365, "year")} ago";
    }

    // Simple format for completed/cancelled requests (shows duration, not "ago")
    private static string FormatDaysSimple(int days)
    {
        if (days <= 0) return "today";
        if (days == 1) return "1 day";
        if (days < 7) return FormatDuration(days, "day");
        if (days < 30) return FormatDuration(days / 7, "week");
        if (days < 365) return FormatDuration(days / 30, "month");
        return FormatDuration(days / 365, "year");
    }

    private static string FormatDuration(TimeSpan? span)
    {
        if (span!.Value.TotalSeconds < 60)
            return $"{Math.Floor(span!.Value.TotalSeconds)} second{Plural(span!.Value.TotalSeconds)}";

        if (span!.Value.TotalMinutes < 60)
            return $"{Math.Floor(span!.Value.TotalMinutes)} minute{Plural(span!.Value.TotalMinutes)}";

        if (span!.Value.TotalHours < 24)
            return $"{Math.Floor(span!.Value.TotalHours)} hour{Plural(span!.Value.TotalHours)}";

        return $"{Math.Floor(span!.Value.TotalDays)} day{Plural(span!.Value.TotalDays)}";
    }

    private static string Plural(double value)
        => Math.Floor(value) == 1 ? "" : "s";

    private static string GetSeverity(TimeSpan span)
    {
        if (span.TotalDays >= 7) return "danger";
        if (span.TotalDays >= 3) return "warning";
        return "info";
    }

    private DateTime? CalculatePendingSince()
    {
        var approvals = Request?.ApprovalsBase.ToList();

        if (Request?.RequestedById == currentUser.UserId)
            return Request.DateCreated;

        var approvalStage = DetermineApprovalStage();
        return Request?.ApprovalsBase?
            .Where(a => a.Stage == approvalStage && a.Action == ApprovalAction.Approve)
            .LastOrDefault()?
            .ActionDate;
    }

    private ApprovalStage? DetermineApprovalStage()
    {
        ApprovalStage? approval = null;
        if (ReportType == "Department")
            approval = ApprovalStage.DepartmentHead;

        if (ReportType == "Division" ||
            (Request?.UserDivisionHeadId == currentUser.UserId &&
             Request?.Status > RequestStatus.ForEndorsement))
            approval = ApprovalStage.DivisionHead;

        if (currentUser.IsCEO)
        {
            if (Request?.Status > RequestStatus.ForCeoApproval)
                approval = ApprovalStage.CeoOrAvp;
        }

        if (currentUser.IsAdmin & Request?.Status > RequestStatus.ForAdminVerification)
            approval = ApprovalStage.Admin;

        return approval;
    }
}
