@using SSDI.RequestMonitoring.UI.JComponents.Cards
@using SSDI.RequestMonitoring.UI.Models.Common
 @using SSDI.RequestMonitoring.UI.Models.Requests.Purchase

<Details__Card>
    <!-- Timeline Header -->
    <DetailsRow__Card FullRow="true" Label="Timeline">
        <div class="timeline-header">
            <div class="timeline-header__title">
                <i class="bi bi-clock-history timeline-header__icon"></i>
                <span>Request History</span>
            </div>
        </div>
    </DetailsRow__Card>

    <DetailsRow__Card FullRow="true">
        <div class="timeline">
            @foreach (var item in Timeline)
            {
                <div class="timeline__item">
                    <div class="timeline__point @item.CssClass"></div>

                    <div class="timeline__content">
                        <div class="timeline__title">@item.Title</div>

                        <div class="timeline__date">
                            @item.Date.ToString("MMM dd, yyyy 'at' hh:mm tt")
                        </div>

                        <div class="timeline__description">
                            @item.Description

                            @if (!string.IsNullOrWhiteSpace(item.Remarks))
                            {
                                <div class="timeline__remarks">@item.Remarks</div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </DetailsRow__Card>
</Details__Card>

@code {
    [Parameter] public IRequestDetailVM Request { get; set; } = default!;

    private class TimelineEvent
    {
        public DateTime Date { get; set; }
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string CssClass { get; set; } = "timeline__point--info";
        public string? Remarks { get; set; }
    }

    private List<TimelineEvent> Timeline => BuildTimeline();

    private List<TimelineEvent> BuildTimeline()
    {
        var list = new List<TimelineEvent>();

        // REQUEST CREATED
        if (Request.DateCreated.HasValue)
        {
            list.Add(new TimelineEvent
            {
                Date = Request.DateCreated.Value,
                Title = "Request Created",
                Description = $"Purchase request was drafted by {(Request.RequestedById is null ? Request.Name : Request.RequestedByName)}",
                CssClass = "timeline__point--primary"
            });
        }

        // REQUEST UPDATED
        if (Request.DateModified.HasValue && Request.DateModified?.ToString("mmddyyyy hh:mm") != Request.DateCreated?.ToString("mmddyyyy hh:mm"))
        {
            list.Add(new TimelineEvent
            {
                Date = Request.DateModified!.Value,
                Title = "Request Updated",
                Description = $"Request details were updated.",
                CssClass = "timeline__point--info"
            }); 
        }

        // APPROVAL EVENTS
        if (Request.ApprovalsBase?.Any() == true)
        {
            foreach (var a in Request.ApprovalsBase)
            {
                if (!a.ActionDate.HasValue) continue;

                list.Add(new TimelineEvent
                {
                    Date = a.ActionDate.Value,
                    Title = $"{utils.GetApprovalStagesDisplay(a.Stage)} - {utils.GetApprovalStatusText(a)}",
                    Description = BuildApprovalDescription(a),
                    Remarks = a.Remarks,
                    CssClass = GetTimelinePointClass(a)
                });
            }
        }

        // REQUISITION SLIP EVENTS
        if (Request.SlipsBase?.Any() == true)
        {
            foreach (var slip in Request.SlipsBase)
            {
                list.Add(new TimelineEvent
                {
                    Date = slip.DateCreated,
                    Title = "Requisition Slip Created",
                    Description =
                        $"Slip created by {slip.RequisitionerName} · Amount: ₱{slip.AmountRequested:N2} · Type: {GetSlipDisplayName(slip.RequisitionSlip_For)}",
                    CssClass = "timeline__point--warning"
                });
            }

            foreach (var slip in Request.SlipsBase)
            {
                if (slip.SlipApprovalDate == null)
                    continue;

                // Determine status
                var approvalStatus = slip.Approval switch
                {
                    ApprovalAction.Approve => "Slip Approved",
                    ApprovalAction.Reject => "Slip Rejected",
                    _ => "Slip Processed"
                };

                list.Add(new TimelineEvent
                {
                    Date = slip.SlipApprovalDate!.Value,  // FIXED ERROR HERE
                    Title = approvalStatus,
                    Description =
                        $"{approvalStatus} by {slip.SlipApproverName} · Amount: ₱{slip.AmountRequested:N2} · Type: {GetSlipDisplayName(slip.RequisitionSlip_For)}",
                    CssClass = slip.Approval == ApprovalAction.Approve 
                        ? "timeline__point--slip-approved"
                        : "timeline__point--slip-rejected",
                 });
            }
        }
         

        // PENDING CLOSURE REQUEST
        if (Request.PendingClosureDate.HasValue)
        {
            list.Add(new TimelineEvent
            {
                Date = Request.PendingClosureDate.Value,
                Title = "Pending Closure Requested",
                Description = $"Request for closure submitted by {(Request.PendingClosureRequestedById is null ? "System" : "User")}",
                CssClass = "timeline__point--pending-closure"
            });
        }

        // REQUEST CLOSED/COMPLETED
        TimelineEvent? closedEvent = null;
        if (Request.IsCompleted && Request.DateCompleted.HasValue)
        {
            closedEvent = new TimelineEvent
            {
                Date = Request.DateCompleted.Value,
                Title = "Request Closed",
                Description = $"Purchase request has been completed and closed.",
                CssClass = "timeline__point--completed"
            };
        }

        // Sort all events by date (excluding closed event)
        var sortedList = list.OrderBy(e => e.Date).ToList();

        // Add closed event at the end if it exists
        if (closedEvent != null)
        {
            sortedList.Add(closedEvent);
        }

        return sortedList;
    }

    private string BuildApprovalDescription(IApprovalVM a)
    {
        if (a.IsApproved)
            return $"Approved by {a.ApproverName}";
        if (a.IsRejected)
            return $"Rejected by {a.ApproverName}";
        if (a.IsCancelled)
            return $"Cancelled by {a.ApproverName}";

        return $"Pending approval from {a.ApproverName}";
    }

    private string GetTimelinePointClass(IApprovalVM approval)
    {
        return approval.IsApproved ? "timeline__point--success"
             : approval.IsRejected ? "timeline__point--danger"
             : approval.IsCancelled ? "timeline__point--cancelled"
             : "timeline__point--warning";
    }
    private string GetSlipDisplayName(RequisitionSlip_For slipFor)
    {
        return slipFor switch
        {
            RequisitionSlip_For.CashPayment => "Cash Payment",
            RequisitionSlip_For.CheckPayment => "Check Payment",
            RequisitionSlip_For.Advances => "Cash Advances",
            RequisitionSlip_For.Others => "Others",
            _ => slipFor.ToString()
        };
    }
}
