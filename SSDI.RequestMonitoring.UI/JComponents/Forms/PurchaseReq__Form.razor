@using SSDI.RequestMonitoring.UI.JComponents.Loading
@using SSDI.RequestMonitoring.UI.Models.Requests
<EditForm Model="Model" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <div class="modal__body">
        <div class="modal__form-group position-relative">
            <!-- Name -->
            <div class="form-group full-width">
                <label for="name">Name</label>
                <input id="name" @bind="Model.Name" class="form-control" style="font-weight: 500;" placeholder="Enter your full name" disabled="@(utils.IsUser())" required />
            </div>

            <!-- Division / Department -->
            <div class="form-group">
                <label for="division">Division / Department</label>
                <input id="division" @bind="Model.Division_Department" class="form-control" placeholder="e.g., FAD / IT Department" required />
            </div>

            <!-- Nature of Request -->
            <div class="form-group">
                <label for="nature">Nature of Request</label>
                <input id="nature" @bind="Model.Nature_Of_Request" class="form-control" placeholder="e.g., Purchase of Equipment" required />
            </div>

            <!-- Justification -->
            <div class="form-group full-width">
                <label for="justification">Justification</label>
                <textarea id="justification" @bind="Model.Justification" class="form-control" placeholder="Describe the reason for this request..." rows="2" required />
            </div>

            <!-- Priority -->
            <div class="form-group full-width">
                <label>Priority</label>
                <FluentRadioGroup Class="radio-group" Name="priority" @bind-Value="Model.Priority">
                    <FluentRadio Class="radio-option" Value="RequestPriority.Hrs24">Must be done within 24 hours</FluentRadio>
                    <FluentRadio Class="radio-option" Value="RequestPriority.ThisWeek">Must be done within the week</FluentRadio>
                    <FluentRadio Class="radio-option" Value="RequestPriority.Others">Others, please specify</FluentRadio>
                </FluentRadioGroup>
                <ValidationMessage For="() => Model.Priority" />

                @if (Model.Priority == RequestPriority.Others)
                {
                    <input @bind="Model.OtherPriority" class="form-control" placeholder="Enter specific priority" required />
                }
            </div>

            <!-- File Upload -->
            @if (!IsForUpdate)
            {
                <div class="form-group full-width">
                    <label for="file-upload">
                        Supporting Documents
                        @if (Model.Attachments.Any())
                        {
                            <span> (@Model.Attachments.Count())</span>
                        }
                    </label>

                    <div class="file-upload-area"
                         @ondragover="OnDragOver"
                         @ondrop="OnDrop">
                        <InputFile id="file-upload"
                                   multiple
                                   OnChange="OnFilesSelected"
                                   class="file-input" />

                        <div class="file-upload-placeholder">
                            <i class="bi bi-cloud-arrow-up-fill upload-icon"></i>
                            <p>Drag & drop files here, or <span class="browse-text">browse</span></p>
                            <small>Supported: PDF, DOCX, JPG, PNG, XLSX (max 10MB each)</small>
                        </div>
                    </div>

                    @if (Model.Attachments.Any())
                    {
                        <ul class="file-list">
                            @foreach (var file in Model.Attachments)
                            {
                                <li class="file-item">
                                    <i class="bi bi-file-earmark"></i>
                                    <span>@file.FileName</span>
                                    <span class="file-size">
                                        (@((file.Size / 1024.0 / 1024.0).ToString("F2")) MB)
                                    </span>
                                    <button type="button" class="remove-btn" @onclick="() => RemoveFile(file)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }

            <LoadingOverlay IsVisible="@IsDisabledBtns" Message="Saving, please wait..." />
        </div>
    </div>
    <div class="modal__footer">
        <button type="button" class="modal__footer-btn modal__footer-btn-cancel" disabled="@IsDisabledBtns" @onclick="OnCloseModal">Cancel</button>
        <button type="submit" class="modal__footer-btn modal__footer-btn-save" disabled="@IsDisabledBtns"> @(IsDisabledBtns ? "Saving..." : "Save") </button>
    </div>
</EditForm>

@code {

    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public Purchase_RequestVM Model { get; set; } = new();
    [Parameter] public bool IsDisabledBtns { get; set; }
    [Parameter] public EventCallback OnValidSubmit { get; set; }
    [Parameter] public EventCallback OnCloseModal { get; set; }
    [Parameter] public bool IsForUpdate { get; set; }

    private List<IBrowserFile> uploadedFiles = new();

    private void OnDragOver(DragEventArgs e)
    {
        // Prevent default only for visual effect (won’t handle files here)
        e.DataTransfer.DropEffect = "copy";
    }

    private void OnDrop(DragEventArgs e)
    {
        // Just stop the browser from navigating away
        // You cannot get IBrowserFile here.
        // Use InputFile’s OnChange to actually capture files.
    }

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > 10 * 1024 * 1024)
                continue; // skip >10MB

            uploadedFiles.Add(file);

            byte[] fileBytes;
            using (var stream = file.OpenReadStream(10 * 1024 * 1024)) // 10MB limit
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                fileBytes = ms.ToArray();
            }

            var attachVM = new Purchase_Request_AttachVM
            {
                UniqId = utils.GenerateUniqId(),
                PurchaseRequestId = Model.Id,
                FileName = file.Name,
                ContentType = file.ContentType,
                ImgData = fileBytes,
                Size = file.Size
            };

            Model.Attachments.Add(attachVM);
        }
    }

    private void RemoveFile(Purchase_Request_AttachVM file)
    {
        // uploadedFiles.Remove(file);

        var toRemove = Model.Attachments.FirstOrDefault(a => a.UniqId == file.UniqId);
        if (toRemove != null)
            Model.Attachments.Remove(toRemove);
    }
}