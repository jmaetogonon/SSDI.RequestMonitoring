@using SSDI.RequestMonitoring.UI.JComponents.Loading
@using SSDI.RequestMonitoring.UI.Models.Common
@using SSDI.RequestMonitoring.UI.Models.Requests.Purchase

<EditForm Model="FormModel" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <div class="modal__body">
        <div class="modal__form-group position-relative">

            <div class="form-group full-width">
                <label for="requisitioner">Requisitioner</label>
                <InputText id="requisitioner" class="form-control" @bind-Value="FormModel.RequisitionerName" readonly />
            </div>

            <div class="form-group">
                <label for="slipFor">Requisition For</label>
                <InputSelect id="slipFor" class="form-select" @bind-Value="FormModel.RequisitionSlip_For" required>
                    @foreach (RequisitionSlip_For type in Enum.GetValues(typeof(RequisitionSlip_For)))
                    {
                        <option value="@type">@GetSlipDisplayName(type)</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="slipDept">Department</label>
                <InputSelect id="slipDept" class="form-select" @bind-Value="FormModel.RequisitionSlip_Dept">
                    @foreach (RequisitionSlip_Dept dept in Enum.GetValues(typeof(RequisitionSlip_Dept)))
                    {
                        <option value="@dept">@GetDeptDisplayName(dept)</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="amount">Amount Requested</label>
                <InputNumber id="amount" class="form-control" @bind-Value="FormModel.AmountRequested" />
            </div>

            <div class="form-group">
                <label for="dateOfRequest">Date of Request</label>
                <InputDate id="dateOfRequest" class="form-control" @bind-Value="FormModel.DateOfRequest" />
            </div>

            <!-- Dynamic fields based on slip type -->
            @if (FormModel.RequisitionSlip_For == RequisitionSlip_For.CashPayment || FormModel.RequisitionSlip_For == RequisitionSlip_For.CheckPayment)
            {
                <div class="form-section">
                    <div class="form-section-title">PAYMENT</div>

                    <div class="form-group full-width">
                        <label for="paymentPayee">Payee</label>
                        <InputText id="paymentPayee" class="form-control" @bind-Value="FormModel.Payment_Payee" />
                    </div>

                    <div class="form-group full-width">
                        <label for="paymentDetails">Payment Details</label>
                        <InputText id="paymentDetails" class="form-control" @bind-Value="FormModel.Payment_PaymentDetails" />
                    </div>

                    <div class="form-group full-width">
                        <label for="paymentReferences">References</label>
                        <InputText id="paymentReferences" class="form-control" @bind-Value="FormModel.Payment_References" />
                    </div>

                    <div class="form-group full-width">
                        <label for="paymentTerms">Payment terms</label>
                        <InputText id="paymentTerms" class="form-control" @bind-Value="FormModel.Payment_PaymentTerms" />
                    </div>
                </div>
            }
            else if (FormModel.RequisitionSlip_For == RequisitionSlip_For.Advances)
            {
                <div class="form-section">
                    <div class="form-section-title"> CASH ADVANCES</div>

                    <div class="form-group full-width">
                        <label for="caActivity">Activity</label>
                        <InputText id="caActivity" class="form-control" @bind-Value="FormModel.CA_Activity" />
                    </div>

                    <div class="form-group">
                        <label for="caTDP">TDP/Circular #</label>
                        <InputText id="caTDP" class="form-control" @bind-Value="FormModel.CA_TDPorCircularNo" />
                    </div>
                    <div class="form-group">
                        <label for="caAWP">AWP #</label>
                        <InputText id="caAWP" class="form-control" @bind-Value="FormModel.CA_AWPNo" />
                    </div>
                    <div class="form-group full-width">
                        <label for="caLiquidation">Liquidation Due Date</label>
                        <InputDate id="caLiquidation" class="form-control" @bind-Value="FormModel.CA_LiquidationDueDate" />
                    </div>
                </div>
            }
            else if (FormModel.RequisitionSlip_For == RequisitionSlip_For.Others)
            {
                <div class="form-section">
                    <div class="form-section-title">OTHERS (please specify below)</div>
                    <div class="form-group full-width">
                        <label for="othersSpecify">Please specify</label>
                        <InputText id="othersSpecify" class="form-control" @bind-Value="FormModel.OthersRequisitionSlip_For" />
                    </div>

                    <div class="form-group full-width">
                        <label for="othersIntendedFor">Intended For</label>
                        <InputText id="othersIntendedFor" class="form-control" @bind-Value="FormModel.Others_IntentedFor" />
                    </div>

                    <div class="form-group full-width">
                        <label for="othersReferences">References</label>
                        <InputText id="othersReferences" class="form-control" @bind-Value="FormModel.Others_References" />
                    </div>
                </div>
            }


            <div class="form-section-title">MATERIALS & SUPPLIES/REPAIRS & MAINTENANCE</div>

            <div class="form-group full-width">
                <label for="othersMatIntendedFor">Intended For</label>
                <InputText id="othersMatIntendedFor" class="form-control" @bind-Value="FormModel.Mat_IntendedFor" />
            </div>

            <div class="form-group full-width">
                <label for="matPrefSupp">Preferred Supplier</label>
                <InputText id="matPrefSupp" class="form-control" @bind-Value="FormModel.Mat_PreferredSupplier" />
            </div>

            <div class="form-group full-width">
                <label for="matRefNo">Ref.# (JO/CI/Quotation)</label>
                <InputText id="matRefNo" class="form-control" @bind-Value="FormModel.Mat_RefNo" />
            </div>

            <div class="form-group full-width">
                <label for="matPayTerms">Payment Terms</label>
                <InputText id="matPayTerms" class="form-control" @bind-Value="FormModel.Mat_PaymentTerms" />
            </div>


            <!-- File Upload -->
            @if (!IsForUpdate)
            {
                <div class="form-group full-width">
                    <label for="file-upload">
                        @(!IsForUpdate ? "Supporting Documents" : "Add More Supporting Documents")
                        @if (SelectedFiles.Any())
                        {
                            <span> (@SelectedFiles.Count())</span>
                        }
                    </label>

                    <div class="file-upload-area"
                         @ondragover="OnDragOver"
                         @ondrop="OnDrop">
                        <InputFile id="file-upload"
                                   multiple
                                   OnChange="OnFilesSelected"
                                   class="file-input" />

                        <div class="file-upload-placeholder">
                            <i class="bi bi-cloud-arrow-up-fill upload-icon"></i>
                            <p>Drag & drop files here, or <span class="browse-text">browse</span></p>
                            <small>Supported: PDF, DOCX, JPG, PNG, XLSX (max 10MB each)</small>
                        </div>
                    </div>

                    @if (SelectedFiles.Any())
                    {
                        <ul class="file-list">
                            @foreach (var file in SelectedFiles)
                            {
                                <li class="file-item">
                                    <i class="bi bi-file-earmark"></i>
                                    <span>@file.FileName</span>
                                    <span class="file-size">
                                        (@((file.Size / 1024.0 / 1024.0).ToString("F2")) MB)
                                    </span>
                                    <button type="button" class="remove-btn" @onclick="() => RemoveFile(file)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }

            <LoadingOverlay IsVisible="@IsDisabledBtns" Message="Saving, please wait..." />
        </div>
    </div>
    <div class="modal__footer">
        <button type="button" class="modal__footer-btn modal__footer-btn-cancel" disabled="@IsDisabledBtns" @onclick="OnCloseModal">Cancel</button>
        <button type="submit" class="modal__footer-btn modal__footer-btn-save" disabled="@IsDisabledBtns"> @(IsDisabledBtns ? "Saving..." : "Save") </button>
    </div>
</EditForm>

@code {
    [Parameter] public ISlipVM FormModel { get; set; } = default!;
    [Parameter] public ICollection<IAttachmentVM> SelectedFiles { get; set; } = new List<IAttachmentVM>();
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool IsDisabledBtns { get; set; }
    [Parameter] public EventCallback OnValidSubmit { get; set; }
    [Parameter] public EventCallback OnCloseModal { get; set; }
    [Parameter] public bool IsForUpdate { get; set; }

    private List<IBrowserFile> uploadedFiles = [];

    private string GetSlipIcon(RequisitionSlip_For slipFor)
    {
        return slipFor switch
        {
            RequisitionSlip_For.CashPayment => "bi-cash",
            RequisitionSlip_For.CheckPayment => "bi-credit-card",
            RequisitionSlip_For.Advances => "bi-cash-coin",
            RequisitionSlip_For.Others => "bi-file-earmark",
            _ => "bi-file-earmark"
        };
    }

    private string GetSlipDisplayName(RequisitionSlip_For slipFor)
    {
        return slipFor switch
        {
            RequisitionSlip_For.CashPayment => "Cash Payment",
            RequisitionSlip_For.CheckPayment => "Check Payment",
            RequisitionSlip_For.Advances => "Cash Advances",
            RequisitionSlip_For.Others => "Others (please specify)",
            _ => slipFor.ToString()
        };
    }

    private string GetDeptDisplayName(RequisitionSlip_Dept dept)
    {
        return dept switch
        {
            RequisitionSlip_Dept.Acctg => "Acctg. Dept.",
            RequisitionSlip_Dept.Sales => "Sales Dept.",
            RequisitionSlip_Dept.Warehouse => "Warehouse Dept.",
            RequisitionSlip_Dept.Satellite => "Satellite",
            _ => dept.ToString()
        };
    }
    private void OnDragOver(DragEventArgs e)
    {
        // Prevent default only for visual effect (won’t handle files here)
        e.DataTransfer.DropEffect = "copy";
    }

    private void OnDrop(DragEventArgs e)
    {
        // Just stop the browser from navigating away
        // You cannot get IBrowserFile here.
        // Use InputFile’s OnChange to actually capture files.
    }

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > 10 * 1024 * 1024)
                continue; // skip >10MB

            uploadedFiles.Add(file);

            byte[] fileBytes;
            using (var stream = file.OpenReadStream(10 * 1024 * 1024)) // 10MB limit
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                fileBytes = ms.ToArray();
            }

            var attachVM = new TempAttachmentForUpload
            {
                FileName = file.Name,
                ContentType = file.ContentType,
                ImgData = fileBytes,
                Size = file.Size,
                UniqId = utils.GenerateUniqId(),
                AttachType = RequestAttachType.Requisition,
            };

            SelectedFiles.Add(attachVM);
        }
    }

    private void RemoveFile(IAttachmentVM file)
    {
        var uniqIdProp = file.GetType().GetProperty("UniqId")?.GetValue(file);
        var toRemove = SelectedFiles.FirstOrDefault(f =>
            f.GetType().GetProperty("UniqId")?.GetValue(f)?.Equals(uniqIdProp) == true
        );

        if (toRemove != null)
            SelectedFiles.Remove(toRemove);
    }

    private class TempAttachmentForUpload : IAttachmentVM
    {
        public int Id { get; set; }
        public string UniqId { get; set; } = Guid.NewGuid().ToString();
        public string FileName { get; set; } = string.Empty;
        public string URL { get; set; } = string.Empty;
        public long Size { get; set; }
        public string ContentType { get; set; } = string.Empty;
        public DateTime? DateCreated { get; set; } = DateTime.Now;
        public byte[]? ImgData { get; set; }
        public RequestAttachType AttachType { get; set; }
        public int RequisitionId { get; set; }
        public decimal ReceiptAmount { get; set; }
        public string ReceiptRemarks { get; set; } = string.Empty;
    }
}
