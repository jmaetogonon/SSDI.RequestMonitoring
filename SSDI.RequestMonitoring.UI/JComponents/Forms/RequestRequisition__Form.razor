@using SSDI.RequestMonitoring.UI.Contracts.MasterData
@using SSDI.RequestMonitoring.UI.JComponents.Controls
@using SSDI.RequestMonitoring.UI.JComponents.Loading
@using SSDI.RequestMonitoring.UI.JComponents.Modals
@using SSDI.RequestMonitoring.UI.Models.Common
@using SSDI.RequestMonitoring.UI.Models.MasterData
@using SSDI.RequestMonitoring.UI.Models.Requests
@using SSDI.RequestMonitoring.UI.Models.Requests.Purchase
@using SSDI.RequestMonitoring.UI.Pages.Settings.SystemConfig.MasterData
@using System.Threading.Tasks

@inject IBusinessUnitSvc businessUnitSvc
@inject IVendorSvc vendorSvc

<Vendor_AddDialog IsModalVisible="@IsAddModalVisible" OnSave="@OnSaveNewVendorModal" OnClose="OnCloseNewVendorModal" />

<EditForm Model="FormModel" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <div class="modal__body">
        <div class="modal__form-group position-relative">

            <div class="form-group">
                <label for="requisitioner">Requisitioner</label>
                <InputText id="requisitioner" class="form-control" @bind-Value="FormModel.RequisitionerName" readonly />
            </div>

            <div class="form-group">
                <label for="dateOfRequest">Date of Request</label>
                <InputDate id="dateOfRequest" class="form-control" @bind-Value="FormModel.DateOfRequest" />
            </div>

            <div class="form-group">
                <label for="slipFor">Requisition For</label>
                <InputSelect id="slipFor" class="form-select" @bind-Value="FormModel.RequisitionSlip_For" required>
                    @foreach (RequisitionSlip_For type in Enum.GetValues(typeof(RequisitionSlip_For)))
                    {
                        <option value="@type">@GetSlipDisplayName(type)</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="slipDept">Business Unit</label>
                @* <InputSelect id="slipDept" class="form-select" @bind-Value="FormModel.BusinessUnitId">
                    @foreach (var bu in businessUnits ?? [])
                    {
                        <option value="@bu.Id">@bu.BU_Code</option>
                    }
                </InputSelect> *@

                <Autocomplete__Control TItem="BusinessUnitVM"
                                       TValue="int"
                                       Items="businessUnits"
                                       @bind-SelectedValue="FormModel.BusinessUnitId"
                                       TextSelector="@(bu => bu.BU_Code)"
                                       ValueSelector="@(bu => bu.Id)"
                                       Placeholder="Select business unit..." />
            </div>

            <div class="form-group">
                <label for="amount">Amount Requested</label>
                <InputNumber id="amount" class="form-control" @bind-Value="FormModel.AmountRequested" />
            </div>

            <div class="form-group">
                <label for="noOfDays">No. of Days to Liquidate</label>
                <InputNumber id="noOfDays" class="form-control" @bind-Value="FormModel.NoOfdaysToLiquidate" />
            </div>

            <!-- Dynamic fields based on slip type -->
            @if (FormModel.RequisitionSlip_For == RequisitionSlip_For.Advances)
            {
                <div class="form-section full-width">
                    <div class="form-section-title"> CASH ADVANCES</div>

                    <div class="form-group full-width">
                        <label for="caActivity">Activity</label>
                        <InputText id="caActivity" class="form-control" @bind-Value="FormModel.CA_Activity" />
                    </div>

                    <div class="form-group">
                        <label for="caTDP">TDP/Circular #</label>
                        <InputText id="caTDP" class="form-control" @bind-Value="FormModel.CA_TDPorCircularNo" />
                    </div>
                    <div class="form-group">
                        <label for="caAWP">AWP #</label>
                        <InputText id="caAWP" class="form-control" @bind-Value="FormModel.CA_AWPNo" />
                    </div>
                    <div class="form-group full-width">
                        <label for="caLiquidation">Liquidation Due Date</label>
                        <InputDate id="caLiquidation" class="form-control" @bind-Value="FormModel.CA_LiquidationDueDate" />
                    </div>
                </div>
            }
            else if (FormModel.RequisitionSlip_For == RequisitionSlip_For.Others)
            {
                <div class="form-section full-width">
                    <div class="form-section-title">OTHERS (please specify below)</div>
                    <div class="form-group full-width">
                        <label for="othersSpecify">Please specify</label>
                        <InputText id="othersSpecify" class="form-control" @bind-Value="FormModel.OthersRequisitionSlip_For" placeholder="e.g., Online Payment" />
                    </div>
                </div>
            }

            <div class="form-section">
                <div class="form-section-title">PAYMENT</div>

                @* <div class="form-group full-width">
                    <label for="paymentPayee">Payee</label>
                    <div class="select-with-actions">
                        <InputSelect id="paymentPayee" class="form-select" @bind-Value="FormModel.Payment_PayeeId" @bind-Value:after="SetSelectedVendorDetails">
                            @foreach (var bu in vendors ?? [])
                            {
                                <option value="@bu.Id">@bu.Vendor_Name</option>
                            }
                        </InputSelect>
                        <div class="select-actions">
                            <i class="bi bi-plus-lg" @onclick="@AddNewPayee" title="Add new payee"></i>
                            <i class="bi bi-arrow-repeat" @onclick="@SyncPayee" title="Sync payees"></i>
                        </div>
                    </div>
                </div> *@
                <div class="form-group full-width">
                    <label for="paymentPayee" class="labelwithicon">
                        Payee
                        <div class="label-actions">
                            <i class="bi bi-plus-lg" @onclick="@AddNewPayee" title="Add new payee"></i>
                            <i class="bi bi-arrow-repeat" @onclick="@SyncPayee" title="Sync payees"></i>
                        </div>
                    </label>

                    <Autocomplete__Control TItem="VendorVM"
                                           TValue="int"
                                           Items="vendors"
                                           @bind-SelectedValue="FormModel.Payment_PayeeId"
                                           @bind-SelectedValue:after="SetSelectedVendor"
                                           TextSelector="@(bu => bu.Vendor_Name)"
                                           ValueSelector="@(bu => bu.Id)"
                                           Placeholder="Search payee..." />
                </div>


                <div class="form-group full-width">
                    <label for="paymentDetails">Payment Details</label>
                    <InputTextArea id="paymentDetails" class="form-control" @bind-Value="FormModel.Payment_PaymentDetails" />
                </div>

                <div class="form-group full-width">
                    <label for="paymentReferences">References</label>
                    <InputText id="paymentReferences" class="form-control" @bind-Value="FormModel.Payment_References" />
                </div>

                <div class="form-group full-width">
                    <label for="paymentTerms">Payment terms</label>
                    <InputText id="paymentTerms" class="form-control" @bind-Value="FormModel.Payment_PaymentTerms" />
                </div>
            </div>

            <div class="form-section-no-bg">
                <div class="form-section-title full-width" style="font-size: 0.80rem;">MATERIALS & SUPPLIES/REPAIRS & MAINTENANCE</div>

                <div class="form-group full-width">
                    <label for="othersMatIntendedFor">Intended For</label>
                    <InputText id="othersMatIntendedFor" class="form-control" @bind-Value="FormModel.Mat_IntendedFor" />
                </div>

                <div class="form-group full-width">
                    <label for="matPrefSupp">Preferred Supplier</label>
                    <InputText id="matPrefSupp" class="form-control" @bind-Value="FormModel.Mat_PreferredSupplier" />
                </div>

                <div class="form-group full-width">
                    <label for="matRefNo">Ref.# (JO/CI/Quotation)</label>
                    <InputText id="matRefNo" class="form-control" @bind-Value="FormModel.Mat_RefNo" />
                </div>

                <div class="form-group full-width">
                    <label for="matPayTerms">Payment Terms</label>
                    <InputText id="matPayTerms" class="form-control" @bind-Value="FormModel.Mat_PaymentTerms" />
                </div>
            </div>


            <!-- File Upload -->
            @if (!IsForUpdate)
            {
                <div class="form-group full-width">
                    <label for="file-upload">
                        @(!IsForUpdate ? "Supporting Documents" : "Add More Supporting Documents")
                        @if (SelectedFiles.Any())
                        {
                            <span> (@SelectedFiles.Count())</span>
                        }
                    </label>

                    <div class="file-upload-area"
                         @ondragover="OnDragOver"
                         @ondrop="OnDrop">
                        <InputFile id="file-upload"
                                   multiple
                                   OnChange="OnFilesSelected"
                                   class="file-input" />

                        <div class="file-upload-placeholder">
                            <i class="bi bi-cloud-arrow-up-fill upload-icon"></i>
                            <p>Drag & drop files here, or <span class="browse-text">browse</span></p>
                            <small>Supported: PDF, DOCX, JPG, PNG, XLSX (max 10MB each)</small>
                        </div>
                    </div>

                    @if (SelectedFiles.Any())
                    {
                        <ul class="file-list">
                            @foreach (var file in SelectedFiles)
                            {
                                <li class="file-item">
                                    <i class="bi bi-file-earmark"></i>
                                    <span>@file.FileName</span>
                                    <span class="file-size">
                                        (@((file.Size / 1024.0 / 1024.0).ToString("F2")) MB)
                                    </span>
                                    <button type="button" class="remove-btn" @onclick="() => RemoveFile(file)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </li>
                            }
                        </ul>
                    }
                </div>
            }

            <LoadingOverlay IsVisible="@IsDisabledBtns" Message="Saving, please wait..." />
        </div>
    </div>
    <div class="modal__footer">
        <button type="button" class="modal__footer-btn modal__footer-btn-cancel" disabled="@IsDisabledBtns" @onclick="OnCloseModal">Cancel</button>
        <button type="submit" class="modal__footer-btn modal__footer-btn-save" disabled="@IsDisabledBtns"> @(IsDisabledBtns ? "Saving..." : "Save") </button>
    </div>
</EditForm>

@code {
    [Parameter] public Request_RS_SlipVM FormModel { get; set; } = default!;
    [Parameter] public ICollection<Request_AttachVM> SelectedFiles { get; set; } = new List<Request_AttachVM>();
    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public bool IsDisabledBtns { get; set; }
    [Parameter] public EventCallback OnValidSubmit { get; set; }
    [Parameter] public EventCallback OnCloseModal { get; set; }
    [Parameter] public bool IsForUpdate { get; set; }
    [Parameter] public Confirmation__Modal? ConfirmModal { get; set; }
    [Parameter] public string AlertMessage { get; set; } = string.Empty;
    [Parameter] public EventCallback<(string Message, AlertType Type)> OnShowAlert { get; set; }

    private IEnumerable<BusinessUnitVM> businessUnits = [];
    private IEnumerable<VendorVM> vendors = [];
    private bool IsAddModalVisible = false;

    protected override async Task OnInitializedAsync()
    {
        businessUnits = await businessUnitSvc.GetAllBusinessUnits();
        vendors = await vendorSvc.GetAllVendors();
    }

    private void SetSelectedVendorDetails()
    {
        if (FormModel.Payment_PayeeId == 0) return;

        FormModel.Payment_PaymentDetails = vendors
            .FirstOrDefault(v => v.Id == FormModel.Payment_PayeeId)?
            .Payment_Details ?? string.Empty;
    }

    private List<IBrowserFile> uploadedFiles = [];

    private string GetSlipIcon(RequisitionSlip_For slipFor)
    {
        return slipFor switch
        {
            RequisitionSlip_For.CashPayment => "bi-cash",
            RequisitionSlip_For.CheckPayment => "bi-credit-card",
            RequisitionSlip_For.Advances => "bi-cash-coin",
            RequisitionSlip_For.Others => "bi-file-earmark",
            _ => "bi-file-earmark"
        };
    }

    private string GetSlipDisplayName(RequisitionSlip_For slipFor)
    {
        return slipFor switch
        {
            RequisitionSlip_For.CashPayment => "Cash Payment",
            RequisitionSlip_For.CheckPayment => "Check Payment",
            RequisitionSlip_For.Advances => "Cash Advances",
            RequisitionSlip_For.Others => "Others (please specify)",
            _ => slipFor.ToString()
        };
    }

    private string GetDeptDisplayName(RequisitionSlip_Dept dept)
    {
        return dept switch
        {
            RequisitionSlip_Dept.Acctg => "Acctg. Dept.",
            RequisitionSlip_Dept.Sales => "Sales Dept.",
            RequisitionSlip_Dept.Warehouse => "Warehouse Dept.",
            RequisitionSlip_Dept.Satellite => "Satellite",
            _ => dept.ToString()
        };
    }
    private void OnDragOver(DragEventArgs e)
    {
        // Prevent default only for visual effect (won’t handle files here)
        e.DataTransfer.DropEffect = "copy";
    }

    private void OnDrop(DragEventArgs e)
    {
        // Just stop the browser from navigating away
        // You cannot get IBrowserFile here.
        // Use InputFile’s OnChange to actually capture files.
    }

    private async Task OnFilesSelected(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > 10 * 1024 * 1024)
                continue; // skip >10MB

            uploadedFiles.Add(file);

            byte[] fileBytes;
            using (var stream = file.OpenReadStream(10 * 1024 * 1024)) // 10MB limit
            using (var ms = new MemoryStream())
            {
                await stream.CopyToAsync(ms);
                fileBytes = ms.ToArray();
            }

            var attachVM = new Request_AttachVM
            {
                FileName = file.Name,
                ContentType = file.ContentType,
                ImgData = fileBytes,
                Size = file.Size,
                UniqId = utils.GenerateUniqId(),
                AttachType = RequestAttachType.Requisition,
            };

            SelectedFiles.Add(attachVM);
        }
    }

    private void RemoveFile(Request_AttachVM file)
    {
        var uniqIdProp = file.GetType().GetProperty("UniqId")?.GetValue(file);
        var toRemove = SelectedFiles.FirstOrDefault(f =>
            f.GetType().GetProperty("UniqId")?.GetValue(f)?.Equals(uniqIdProp) == true
        );

        if (toRemove != null)
            SelectedFiles.Remove(toRemove);
    }

    private void AddNewPayee() => IsAddModalVisible = true;

    private async Task SyncPayee()
    {
        var options = new ConfirmationModalOptions
        {
            Message = "Are you sure you want to sync payees from server?",
            Title = "Sync Payees",
            Variant = ConfirmationModalVariant.confirmation,
            ConfirmText = "Yes, Sync",
            CancelText = "No, Cancel",
        };

        var result = await ConfirmModal!.ShowAsync(options);
        if (!result) return;

        try
        {
            await ConfirmModal!.SetLoadingAsync(true);

            var response = await vendorSvc.SyncVendors();

            if (!response)
            {
                await OnShowAlert.InvokeAsync(("Something went wrong. Please try again.", AlertType.error));
                return;
            }

            vendors = await vendorSvc.GetAllVendors();
            await OnShowAlert.InvokeAsync(("Payees were synced successfully.", AlertType.success));
            StateHasChanged();

            await CloseModalWithLoading();

        }
        catch (Exception ex)
        {
            await OnShowAlert.InvokeAsync(($"An error occurred while syncing: {ex.Message}", AlertType.error));
            await CloseModalWithLoading();
        }
    }


    private void OnCloseNewVendorModal() => IsAddModalVisible = false;

    private async Task OnSaveNewVendorModal(VendorVM newVendor)
    {
        IsAddModalVisible = false;
        await OnShowAlert.InvokeAsync(("The new payee has been added successfully.", AlertType.success));

        var syncResponse = await vendorSvc.SyncVendors();
        if (!syncResponse)
        {
            await OnShowAlert.InvokeAsync(("The new payee has been added successfully but failed to sync payees from server. Please sync again.", AlertType.error));
            return;
        }

        vendors = await vendorSvc.GetAllVendors();

        if (newVendor != null && !string.IsNullOrEmpty(newVendor?.Vendor_Name))
        {
            var addedVendor = vendors.FirstOrDefault(v => v.Vendor_Name == newVendor.Vendor_Name);
            if (addedVendor != null)
            {
                FormModel.Payment_PayeeId = addedVendor.Id;
                FormModel.Payment_PaymentDetails = addedVendor.Payment_Details;
            }
        }
    }

    private async Task CloseModalWithLoading()
    {
        await ConfirmModal!.SetLoadingAsync(false);
        await ConfirmModal!.HideAsync();
    }

    private void SetSelectedVendor()
    {
        var addedVendor = vendors.FirstOrDefault(v => v.Id == FormModel.Payment_PayeeId);
        if (addedVendor != null)
        {
            FormModel.Payment_PaymentDetails = addedVendor.Payment_Details;
        }
        else{
            FormModel.Payment_PaymentDetails = string.Empty;
        }
    }

}
