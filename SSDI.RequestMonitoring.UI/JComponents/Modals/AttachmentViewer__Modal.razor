@using SSDI.RequestMonitoring.UI.Contracts.Requests.Common
@using SSDI.RequestMonitoring.UI.JComponents.Loading
@using SSDI.RequestMonitoring.UI.Models.Common
@using SSDI.RequestMonitoring.UI.Models.Requests
@using SSDI.RequestMonitoring.UI.Models.Requests.Purchase
@inject IAttachSvc attachSvc

@if (ShowPreview && SelectedAttachment != null)
{
    <div class="attachment-preview-modal"
         @onkeydown="HandleKeyDown"
         tabindex="0"
         @ref="_modalElement">

        <div class="attachment-preview-modal__overlay" @onclick="ClosePreview"></div>

        <div class="attachment-preview-modal__content">
            <div class="attachment-preview-modal__header">
                <h3 class="attachment-preview-modal__title">@SelectedAttachment?.FileName</h3>
                <button class="attachment-preview-modal__close" @onclick="ClosePreview">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="attachment-preview-modal__body">
                @if (IsLoadingPreview)
                {
                    <div class="preview-loading">
                        <div class="preview-loading__spinner"></div>
                        <p>Loading preview...</p>
                    </div>
                }
                else if (IsImage(SelectedAttachment!.FileName))
                {
                    <div class="image-preview-container">
                        <div class="image-viewport">
                            <img src="@PreviewUrl"
                                 alt="@SelectedAttachment.FileName"
                                 class="preview-image"
                                 style="transform: scale(@_imageScale)"
                                 @onload="OnImageLoad"
                                 @onerror="OnImageError" />

                            @if (!_isImageLoaded && !_isImageError)
                            {
                                <div class="image-loading">
                                    <div class="image-loading__spinner"></div>
                                    <p>Loading image...</p>
                                </div>
                            }

                            @if (_isImageError)
                            {
                                <div class="image-error">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <p>Failed to load image</p>
                                </div>
                            }
                        </div>

                        @if (_isImageLoaded)
                        {
                            <div class="image-controls">
                                <button class="control-btn" @onclick="ZoomOut" title="Zoom Out">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <span class="zoom-level">@((_imageScale * 100).ToString("0"))%</span>
                                <button class="control-btn" @onclick="ZoomIn" title="Zoom In">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                                <button class="control-btn" @onclick="ResetZoom" title="Reset Zoom">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
                else if (IsPdf(SelectedAttachment.FileName))
                {
                    <div class="pdf-preview-container">
                        <object data="@PreviewUrl"
                                type="application/pdf"
                                class="pdf-object"
                                @onload="OnPdfLoad"
                                @onerror="OnPdfError">
                            <div class="pdf-fallback">
                                <i class="bi bi-file-pdf"></i>
                                <h4>PDF Preview Not Available</h4>
                                <p>Your browser doesn't support embedded PDF preview.</p>
                            </div>
                        </object>

                        @if (!_isPdfLoaded && !_isPdfError)
                        {
                            <div class="pdf-loading">
                                <div class="pdf-loading__spinner"></div>
                                <p>Loading PDF...</p>
                            </div>
                        }

                        @if (_isPdfError)
                        {
                            <div class="pdf-error">
                                <i class="bi bi-exclamation-triangle"></i>
                                <p>Failed to load PDF</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="generic-preview">
                        <div class="generic-icon">
                            <i class="@GetFileIcon(SelectedAttachment.FileName)"></i>
                        </div>
                        <div class="generic-content">
                            <h4>@SelectedAttachment.FileName</h4>
                            <p>Preview not available for this file type</p>
                        </div>
                    </div>
                }
            </div>

            <!-- Global Action Buttons -->
            <div class="preview-actions">
                <button class="btn btn--primary" @onclick="() => DownloadAttachment(SelectedAttachment!)">
                    <i class="bi bi-download"></i>
                    Download
                </button>
                <button class="btn btn--outline" @onclick="ClosePreview">
                    <i class="bi bi-x"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool ShowPreview { get; set; }
    [Parameter] public bool IsLoadingPreview { get; set; }
    [Parameter] public Request_AttachVM? SelectedAttachment { get; set; }
    [Parameter] public string? PreviewUrl { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private ElementReference _modalElement;
    private bool _isImageLoaded = false;
    private bool _isImageError = false;
    private bool _isPdfLoaded = false;
    private bool _isPdfError = false;
    private double _imageScale = 1.0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (ShowPreview)
        {
            await _modalElement.FocusAsync();
        }
    }

    protected override void OnParametersSet()
    {
        if (ShowPreview && SelectedAttachment != null)
        {
            if (IsImage(SelectedAttachment.FileName))
            {
                _isImageLoaded = false;
                _isImageError = false;
                _imageScale = 1.0;
            }
            else if (IsPdf(SelectedAttachment.FileName))
            {
                _isPdfLoaded = false;
                _isPdfError = false;
            }
        }
        else if (!ShowPreview)
        {
            _isImageLoaded = false;
            _isImageError = false;
            _isPdfLoaded = false;
            _isPdfError = false;
            _imageScale = 1.0;
        }
    }

    private void OnImageLoad()
    {
        _isImageLoaded = true;
        _isImageError = false;
        StateHasChanged();
    }

    private void OnImageError()
    {
        _isImageLoaded = false;
        _isImageError = true;
        StateHasChanged();
    }

    private void OnPdfLoad()
    {
        _isPdfLoaded = true;
        _isPdfError = false;
        StateHasChanged();
    }

    private void OnPdfError()
    {
        _isPdfLoaded = false;
        _isPdfError = true;
        StateHasChanged();
    }

    private void ZoomIn()
    {
        _imageScale = Math.Min(_imageScale + 0.25, 3.0);
        StateHasChanged();
    }

    private void ZoomOut()
    {
        _imageScale = Math.Max(_imageScale - 0.25, 0.5);
        StateHasChanged();
    }

    private void ResetZoom()
    {
        _imageScale = 1.0;
        StateHasChanged();
    }

    private async void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" && ShowPreview)
        {
            await ClosePreview();
        }
        else if (ShowPreview && IsImage(SelectedAttachment!.FileName))
        {
            if (e.Key == "+" || e.Key == "=")
            {
                ZoomIn();
            }
            else if (e.Key == "-")
            {
                ZoomOut();
            }
            else if (e.Key == "0")
            {
                ResetZoom();
            }
        }
    }

    private async Task ClosePreview()
    {
        ShowPreview = false;
        SelectedAttachment = null;
        PreviewUrl = null;
        IsLoadingPreview = false;
        _isImageLoaded = false;
        _isImageError = false;
        _isPdfLoaded = false;
        _isPdfError = false;
        _imageScale = 1.0;

        if (OnClose.HasDelegate)
        {
            await OnClose.InvokeAsync();
        }

        StateHasChanged();
    }

    private async Task DownloadAttachment(Request_AttachVM attachment, MouseEventArgs? e = null)
    {
        try
        {
            var fileBytes = await attachSvc.GetAttachByte(attachment.Id);
            var fileName = attachment.FileName;

            if (fileBytes != null && fileBytes.Length > 0)
            {
                await jsRuntime.InvokeVoidAsync("saveAsFile", fileName, Convert.ToBase64String(fileBytes));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading attachment: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private bool IsImage(string fileName)
    {
        if (string.IsNullOrEmpty(fileName)) return false;
        var extension = Path.GetExtension(fileName).ToLower();
        return extension is ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".webp";
    }

    private bool IsPdf(string fileName)
    {
        if (string.IsNullOrEmpty(fileName)) return false;
        return Path.GetExtension(fileName).ToLower() == ".pdf";
    }

    private string GetFileIcon(string fileName)
    {
        if (string.IsNullOrEmpty(fileName)) return "bi bi-file-earmark";

        var extension = Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".pdf" => "bi bi-file-pdf",
            ".doc" or ".docx" => "bi bi-file-word",
            ".xls" or ".xlsx" => "bi bi-file-excel",
            ".jpg" or ".jpeg" or ".png" or ".gif" or ".bmp" or ".webp" => "bi bi-file-image",
            ".zip" or ".rar" or ".7z" => "bi bi-file-zip",
            ".txt" => "bi bi-file-text",
            _ => "bi bi-file-earmark"
        };
    }

    public async ValueTask DisposeAsync()
    {
        await Task.CompletedTask;
    }
}