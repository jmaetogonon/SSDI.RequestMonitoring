@inherits ComponentBase

<div class="pdf-modal @(IsVisible ? "pdf-modal--visible" : "")">
    <div class="pdf-modal__overlay" @onclick="Close"></div>
    <div class="pdf-modal__dialog" @onclick:stopPropagation>
        <!-- Header -->
        <div class="pdf-modal__header">
            <div class="pdf-modal__title">
                <i class="bi bi-file-earmark-pdf pdf-modal__icon"></i>
                <div class="pdf-modal__title-content">
                    <h3>@FileName</h3>
                    <span class="pdf-modal__subtitle">PDF Preview</span>
                </div>
            </div>
            <button class="pdf-modal__close" @onclick="Close" title="Close">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Body -->
        <div class="pdf-modal__body">
            @if (string.IsNullOrWhiteSpace(PdfBase64) || isLoading)
            {
                <div class="pdf-modal__loading">
                    <div class="pdf-modal__spinner"></div>
                    <p>Loading PDF preview...</p>
                </div>
            }
            else
            {
                <div class="pdf-viewer">
                    <iframe src="data:application/pdf;base64,@PdfBase64#toolbar=1&navpanes=0&scrollbar=1"
                            width="100%" height="100%"
                            style="border:none;"
                            title="PDF Document Viewer"
                            @onload="OnPdfLoaded"
                            @onerror="OnPdfError">
                    </iframe>
                    <div class="pdf-viewer__fallback @(showPdfFallback ? "pdf-viewer__fallback--visible" : "")">
                        <i class="bi bi-file-earmark-pdf pdf-viewer__fallback-icon"></i>
                        <h4>PDF Preview Not Available</h4>
                        <p>Your browser doesn't support embedded PDF preview.</p>
                        <button class="btn btn--primary" @onclick="DownloadPdf">
                            <i class="bi bi-download"></i>
                            Download PDF
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Footer -->
        <div class="pdf-modal__footer">
            <div class="pdf-modal__footer-actions">
                <button class="btn btn--primary" @onclick="DownloadPdf" title="Download PDF">
                    <i class="bi bi-download"></i>
                    Download PDF
                </button>
                <button class="btn btn--outline" @onclick="Close" title="Close preview">
                    <i class="bi bi-x-lg"></i>
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? PdfBase64 { get; set; }
    [Parameter] public string? FileName { get; set; } = "Document.pdf";
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private bool showPdfFallback = false;
    private bool isLoading = true;

    protected override void OnParametersSet()
    {
        if (IsVisible && !string.IsNullOrWhiteSpace(PdfBase64))
        {
            isLoading = false;
            showPdfFallback = false;
        }
    }

    private void OnPdfLoaded()
    {
        isLoading = false;
        StateHasChanged();
    }

    private void OnPdfError()
    {
        isLoading = false;
        showPdfFallback = true;
        StateHasChanged();
    }

    private async Task DownloadPdf()
    {
        if (string.IsNullOrWhiteSpace(PdfBase64)) return;

        try
        {
            await jsRuntime.InvokeVoidAsync("downloadBase64File", "application/pdf", PdfBase64, FileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
    }

    private async Task Close()
    {
        isLoading = true;
        showPdfFallback = false;
        await OnClose.InvokeAsync();
    }
}