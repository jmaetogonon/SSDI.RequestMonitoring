@using Microsoft.AspNetCore.Components.Authorization

<div class="navmenu">
    @if (isMobile)
    {
        <input type="checkbox" id="navmenu-toggle" class="navmenu-toggle" @bind="expanded" />
        <label for="navmenu-toggle" class="navmenu-icon">
            <FluentIcon Value="@(new Icons.Regular.Size20.Navigation())" Color="Color.Fill" />
        </label>
    }
    <button id="navmenu-toggle" style="display:none"></button>


    @if (expanded && isMobile)
    {
        <div class="navmenu-backdrop" @onclick="HideMenu"></div>
    }

    <nav class="sitenav slide-in-left @(expanded && isMobile ? "open" : "")" aria-labelledby="main-menu">
        <FluentNavMenu Id="main-menu" Title="Navigation menu" @bind-Expanded="expanded" CustomToggle="true">
            <FluentNavMenu Id="main-menu" Width="250" Collapsible="true" Title="Navigation menu" @bind-Expanded="expanded" CustomToggle="true">
                @if (isMobile)
                {
                    <div class="navmenu__logo">
                        <img src="/images/logo/app-logo-square-trans.png" />
                        <p> Requests Monitoring</p>
                    </div>
                }
                <div class="sidebar__section-title una" style="margin-top: 1rem !important;">General</div>

                <FluentNavLink Href="/dashboard" Match="NavLinkMatch.All" Icon="@(new Icons.Regular.Size20.Home())">Dashboard</FluentNavLink>
                <FluentNavLink Href="/requests/purchase-requests" Icon="@(new Icons.Regular.Size20.ShoppingBag())">Purchase Requests</FluentNavLink>
                <FluentNavLink Href="/requests/job-orders" Icon="@(new Icons.Regular.Size20.Wrench())">Job Orders</FluentNavLink>


                <AuthorizeView Roles="@TokenCons.Role__Admin">
                    <Authorized>
                        @* <div class="sidebar__section-title">Master Data</div> 
                        <FluentNavGroup Title="Organization" Icon="@(new Icons.Regular.Size20.Building())">
                            <FluentNavLink Href="/masterdata/divisions" Icon="@(new Icons.Regular.Size20.People())">Divisions</FluentNavLink>
                            <FluentNavLink Href="/masterdata/job-departments" Icon="@(new Icons.Regular.Size20.PeopleTeam())">Departments</FluentNavLink>
                        </FluentNavGroup> *@

                        <div class="sidebar__section-title">Settings</div>
                        <FluentNavLink Href="/system-configuration" Icon="@(new Icons.Regular.Size20.Settings())">System Configuration</FluentNavLink>
                    </Authorized>
                </AuthorizeView>

            </FluentNavMenu>
        </FluentNavMenu>
    </nav>
</div>


@code {
    private bool expanded = true;
    private bool isMobile = false;
    protected override async Task OnInitializedAsync()
    {
        await currentUser.InitializeAsync();
        currentUser.OnUserChanged += Refresh;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await jsRuntime.InvokeVoidAsync("addResizeListener", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public void SetIsMobile(int width)
    {
        isMobile = width <= 600;
        expanded = !isMobile; // expanded = true when NOT mobile
        StateHasChanged();
    }

    private void HideMenu()
    {
        expanded = false;
    }

    private void Refresh()
    {
        InvokeAsync(StateHasChanged);
    }
    public void Dispose()
    {
        currentUser.OnUserChanged -= Refresh;
    }
}
