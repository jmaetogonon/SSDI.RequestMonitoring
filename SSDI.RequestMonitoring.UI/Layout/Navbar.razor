@using SSDI.RequestMonitoring.UI.Contracts
@using SSDI.RequestMonitoring.UI.Contracts.Users
@using SSDI.RequestMonitoring.UI.Helpers.States
@using SSDI.RequestMonitoring.UI.Layout.Components
@using SSDI.RequestMonitoring.UI.Models.Common
@using SSDI.RequestMonitoring.UI.Models.Users
@inject IAuthenticationSvc authService
@inject IJSRuntime JSRuntime

<div class="navbar">
    <!-- Left Section: Logo -->
    <div class="navbar__logo" @onclick="@(() => navigationManager.NavigateTo("/dashboard"))">
        <img src="/images/logo/app-logo-square-trans.png" />
        <p>Requests Monitoring</p>
    </div>

    <!-- Right Section: User Account -->
    <div class="navbar__right">
        <div class="navbar__user__account">
            <div class="user-menu" @onclick="ToggleMenu">
                <div class="user-avatar">
                    @GetInitials(currentUser.FullName)
                </div>
                <i class="bi bi-chevron-down dropdown-arrow @(isMenuOpen ? "rotated" : "")"></i>
            </div>

            @if (isMenuOpen)
            {
                <div class="dropdown-backdrop" @onclick="CloseMenu"></div>
                <div class="user-dropdown">
                    <div class="dropdown-header">
                        <div class="avatar-big">@GetInitials(currentUser.FullName)</div>
                        <div class="user-info">
                            <strong>@currentUser.FullName</strong>
                            <span>@currentUser.RoleDesc</span>
                            <small>@currentUser.Username</small>
                        </div>
                    </div>

                    <div class="dropdown-items">
                        <button class="dropdown-item" @onclick="OpenSettings">
                            <i class="bi bi-gear"></i>
                            <span>Settings</span>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="dropdown-divider"></div>

                    <div class="dropdown-actions">
                        <button class="btn btn--danger btn--full" @onclick="Logout">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Settings Modal -->
@if (showSettingsModal)
{
    <SettingsModal @ref="settingsModalRef"
                   @bind-Visible="showSettingsModal" />
}

@code {
    private bool isMenuOpen = false;
    private bool showSettingsModal = false;
    private SettingsModal? settingsModalRef;

    protected override async Task OnInitializedAsync()
    {
        await currentUser.InitializeAsync();
        currentUser.OnUserChanged += Refresh;
    }

    private void Refresh()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleMenu()
    {
        isMenuOpen = !isMenuOpen;
    }

    private void CloseMenu()
    {
        isMenuOpen = false;
    }

    private void OpenSettings()
    {
        isMenuOpen = false;
        showSettingsModal = true;
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "--";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length == 1)
            return parts[0][0].ToString().ToUpper();

        var first = parts.First()[0];
        var last = parts.Last()[0];

        return $"{char.ToUpper(first)}{char.ToUpper(last)}";
    }

    private async Task Logout()
    {
        isMenuOpen = false;
        await authService.Logout();
        navigationManager.NavigateTo("/");
    }

    public void Dispose()
    {
        currentUser.OnUserChanged -= Refresh;
    }
}