@page "/dashboard"
@attribute [Authorize]
@using SSDI.RequestMonitoring.UI.Contracts.Requests.JobOrder
@using SSDI.RequestMonitoring.UI.Contracts.Requests.Purchase
@using SSDI.RequestMonitoring.UI.Contracts.Users
@using SSDI.RequestMonitoring.UI.JComponents.Cards
@using SSDI.RequestMonitoring.UI.JComponents.Modals
@using SSDI.RequestMonitoring.UI.Models.Requests
@using SSDI.RequestMonitoring.UI.Models.Requests.Purchase
@using SSDI.RequestMonitoring.UI.Models.Requests.JobOrder
@using SSDI.RequestMonitoring.UI.Pages.Dashboard.Cards
@using SSDI.RequestMonitoring.UI.Pages.Dashboard.Charts
@inject IPurchaseRequestSvc purchaseRequestSvc
@inject IJobOrderSvc jobOrderSvc
@inject IUserSvc userSvc

<PageTitle>Dashboard</PageTitle>

<div class="dashboard">
    <!-- Header -->
    <div class="dashboard__header">
        <div class="dashboard__welcome">
            <h1>Good @(GetTimeOfDayGreeting()), @(currentUser.FullName?.Split(' ').FirstOrDefault() ?? "User")!</h1>
            <p class="dashboard__subtitle">Here's your request overview</p>
        </div>

        <div class="dashboard__header-actions">
            <!-- Quick Stats -->
            <div class="header-stats">
                <div class="header-stat">
                    <i class="bi bi-calendar-check"></i>
                    <div class="header-stat__content">
                        <span class="header-stat__value">@DateTime.Now.ToString("MMM dd")</span>
                        <span class="header-stat__label">Today</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="header-quick-actions">
                @if (currentUser.IsAdmin)
                {
                    <button class="header-action-btn" @onclick="SyncUsers" title="Sync Users from Active Directory">
                        <i class="bi bi-people"></i>
                        <span>Sync Users</span>
                    </button>
                }

                <button class="header-action-btn" @onclick="RefreshDashboard" title="Refresh dashboard data">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Request Type Tabs -->
    <div class="dashboard__tabs">
        <button class="dashboard__tab @(activeTab == "all" ? "dashboard__tab--active" : "")"
                @onclick="@(() => SwitchTab("all"))">
            <i class="bi bi-grid"></i>
            All Requests
        </button>
        <button class="dashboard__tab @(activeTab == "purchase" ? "dashboard__tab--active" : "")"
                @onclick="@(() => SwitchTab("purchase"))">
            <i class="bi bi-cart"></i>
            Purchase Requests
            <span class="tab-badge">@purchaseRequestMetrics.TotalCount</span>
        </button>
        <button class="dashboard__tab @(activeTab == "joborder" ? "dashboard__tab--active" : "")"
                @onclick="@(() => SwitchTab("joborder"))">
            <i class="bi bi-tools"></i>
            Job Orders
            <span class="tab-badge">@jobOrderMetrics.TotalCount</span>
        </button>
    </div>

    <div class="dashboard__tabs-items">
        <!-- Metrics Container -->
        <div class="metrics-container">
            <!-- Desktop Grid View (default) -->
            <div class="metrics-grid">
                @if (activeTab == "all")
                {
                    <StatusWBar__Card Label="Total Requests"
                                      Count="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-inbox"
                                      OnClick="@(() => ViewAllRequests())" />

                    <StatusWBar__Card Label="Pendings"
                                      Count="@(purchaseRequestMetrics.AllPendingCount + jobOrderMetrics.AllPendingCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-clock"
                                      OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />

                    <StatusWBar__Card Label="Rejected"
                                      Count="@(purchaseRequestMetrics.RejectedCount + jobOrderMetrics.RejectedCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-x-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />

                    <StatusWBar__Card Label="Closed"
                                      Count="@(purchaseRequestMetrics.CompletedCount + jobOrderMetrics.CompletedCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-check-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
                }
                else if (activeTab == "purchase")
                {
                    <StatusWBar__Card Label="Total Purchase Requests"
                                      Count="@purchaseRequestMetrics.TotalCount"
                                      TotalCount="@purchaseRequestMetrics.TotalCount"
                                      Icon="bi bi-cart"
                                      OnClick="@(() => ViewAllRequests())" />

                    <StatusWBar__Card Label="Pendings"
                                      Count="@(purchaseRequestMetrics.AllPendingCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount)"
                                      Icon="bi bi-clock"
                                      OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />

                    <StatusWBar__Card Label="Rejected"
                                      Count="@(purchaseRequestMetrics.RejectedCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount)"
                                      Icon="bi bi-x-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />

                    <StatusWBar__Card Label="Closed"
                                      Count="@(purchaseRequestMetrics.CompletedCount)"
                                      TotalCount="@(purchaseRequestMetrics.TotalCount)"
                                      Icon="bi bi-check-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
                }
                else if (activeTab == "joborder")
                {
                    <StatusWBar__Card Label="Total Job Orders"
                                      Count="@jobOrderMetrics.TotalCount"
                                      TotalCount="@jobOrderMetrics.TotalCount"
                                      Icon="bi bi-tools"
                                      OnClick="@(() => ViewAllRequests())" />

                    <StatusWBar__Card Label="Pendings"
                                      Count="@(jobOrderMetrics.AllPendingCount)"
                                      TotalCount="@(jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-clock"
                                      OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />

                    <StatusWBar__Card Label="Rejected"
                                      Count="@(jobOrderMetrics.RejectedCount)"
                                      TotalCount="@(jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-x-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />

                    <StatusWBar__Card Label="Closed"
                                      Count="@(jobOrderMetrics.CompletedCount)"
                                      TotalCount="@(jobOrderMetrics.TotalCount)"
                                      Icon="bi bi-check-circle"
                                      OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
                }
            </div>

            <!-- Mobile Carousel View -->
            <div class="metrics-carousel" @ref="carouselContainer" @onwheel="HandleWheel">
                <!-- Previous Button (Left side) -->
                <div class="carousel-nav prev">
                    <button class="carousel-btn prev-btn" @onclick="PrevSlide"
                            disabled="@(currentSlide == 0)" title="Previous">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>

                <!-- Carousel Slides -->
                <div class="carousel-inner" style="transform: translateX(@($"-{currentSlide * 100}%"));">
                    @if (activeTab == "all")
                    {
                        @RenderCarouselSlidesForAll()
                    }
                    else if (activeTab == "purchase")
                    {
                        @RenderCarouselSlidesForPurchase()
                    }
                    else if (activeTab == "joborder")
                    {
                        @RenderCarouselSlidesForJobOrder()
                    }
                </div>

                <!-- Next Button (Right side) -->
                <div class="carousel-nav next">
                    <button class="carousel-btn next-btn" @onclick="NextSlide"
                            disabled="@(currentSlide == GetTotalSlides() - 1)" title="Next">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>

                <!-- Slide Indicators (Below the card) -->
                <div class="carousel-indicators">
                    @for (int i = 0; i < GetTotalSlides(); i++)
                    {
                        <button class="indicator @(i == currentSlide ? "active" : "")"
                                @onclick="@(() => GoToSlide(i))"
                                aria-label="Go to slide @(i + 1)">
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="dashboard__grid">
            <!-- Left Column: Recent Activity & Quick Actions -->
            <div class="dashboard__column">
                <!-- Supervisor Specific: Team Requests -->
                @if (currentUser.IsSupervisor)
                {
                    <TeamRequest__Card Items="teamRequestsNeedingAttention" RequestType="requestType" />
                }

                <!-- User Recent Activity -->
                @if (currentUser.IsUser || !currentUser.IsSupervisor)
                {
                    <RecentActivity__Card Items="recentActivity" RequestType="requestType" />
                }

                <!-- Performance Stats -->
                <PerformanceOverview__Card JobOrderMetrics="jobOrderMetrics" PurchaseRequestMetrics="purchaseRequestMetrics" Purchase_Requests="purchaseRequests" Job_Orders="jobOrders" RequestType="requestType" />
            </div>

            <!-- Right Column: Charts -->
            <div class="dashboard__column">
                <!-- Volume Comparison Chart -->
                <VolumeComparison__Bar PurchaseRequests="purchaseRequests" JobOrders="jobOrders" RequestType="requestType" />

                @if (currentUser.IsSupervisor)
                {
                    <ApprovedRequests__Card Items="approveReqyestItems" RequestType="requestType" />
                }

                <!-- Status Overview -->
                <StatusDistribution__Bar PurchaseRequests="purchaseRequests" JobOrders="jobOrders" RequestType="requestType" />
            </div>
        </div>
    </div>
</div>
<Confirmation__Modal @ref="confirmModal" />

@if (isLoading)
{
    <div class="dashboard-loading">
        <div class="loading-spinner"></div>
    </div>
}

@code {
    private RenderFragment RenderCarouselSlidesForAll() => @<text>
        <div class="carousel-slide">
            <StatusWBar__Card Label="Total Requests"
                              Count="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                              Icon="bi bi-inbox"
                              OnClick="@(() => ViewAllRequests())" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Pendings"
                              Count="@(purchaseRequestMetrics.AllPendingCount + jobOrderMetrics.AllPendingCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                              Icon="bi bi-clock"
                              OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Rejected"
                              Count="@(purchaseRequestMetrics.RejectedCount + jobOrderMetrics.RejectedCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                              Icon="bi bi-x-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Closed"
                              Count="@(purchaseRequestMetrics.CompletedCount + jobOrderMetrics.CompletedCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount + jobOrderMetrics.TotalCount)"
                              Icon="bi bi-check-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
        </div>

    </text>;

    private RenderFragment RenderCarouselSlidesForPurchase() => @<text>
        <div class="carousel-slide">
            <StatusWBar__Card Label="Total Purchase Requests"
                              Count="@purchaseRequestMetrics.TotalCount"
                              TotalCount="@purchaseRequestMetrics.TotalCount"
                              Icon="bi bi-cart"
                              OnClick="@(() => ViewAllRequests())" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Pendings"
                              Count="@(purchaseRequestMetrics.AllPendingCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount)"
                              Icon="bi bi-clock"
                              OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Rejected"
                              Count="@(purchaseRequestMetrics.RejectedCount)"
                              TotalCount="@(purchaseRequestMetrics.TotalCount)"
                              Icon="bi bi-x-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Closed"
                              Count="@purchaseRequestMetrics.CompletedCount"
                              TotalCount="@purchaseRequestMetrics.TotalCount"
                              Icon="bi bi-check-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
        </div>
    </text>;

    private RenderFragment RenderCarouselSlidesForJobOrder() => @<text>
        <div class="carousel-slide">
            <StatusWBar__Card Label="Total Job Orders"
                              Count="@jobOrderMetrics.TotalCount"
                              TotalCount="@jobOrderMetrics.TotalCount"
                              Icon="bi bi-tools"
                              OnClick="@(() => ViewAllRequests())" />
        </div>


        <div class="carousel-slide">
            <StatusWBar__Card Label="Pendings"
                              Count="@(jobOrderMetrics.AllPendingCount)"
                              TotalCount="@(jobOrderMetrics.TotalCount)"
                              Icon="bi bi-clock"
                              OnClick="@(() => FilterByStatus(RequestStatus.PendingRequesterClosure))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Rejected"
                              Count="@(jobOrderMetrics.RejectedCount)"
                              TotalCount="@(jobOrderMetrics.TotalCount)"
                              Icon="bi bi-x-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Rejected))" />
        </div>

        <div class="carousel-slide">
            <StatusWBar__Card Label="Closed"
                              Count="@jobOrderMetrics.CompletedCount"
                              TotalCount="@jobOrderMetrics.TotalCount"
                              Icon="bi bi-check-circle"
                              OnClick="@(() => FilterByStatus(RequestStatus.Closed))" />
        </div>
    </text>;
}