@page "/requests/job-orders/{paramId:int}/{reportType?}"
@using SSDI.RequestMonitoring.UI.Contracts.MasterData
@using SSDI.RequestMonitoring.UI.Contracts.Requests.JobOrder
@using SSDI.RequestMonitoring.UI.JComponents.Controls
@using SSDI.RequestMonitoring.UI.JComponents.Controls.Requests
@using SSDI.RequestMonitoring.UI.JComponents.Modals
@using SSDI.RequestMonitoring.UI.Pages.Requests.JobOrder.Modals
@using SSDI.RequestMonitoring.UI.Services.Adapters.Requests
@using SSDI.RequestMonitoring.UI.Services.Adapters.Requests.RequisitionSlip
@inject IJobOrderSvc jobOrderSvc
@inject JOAttachSvcAdapter joAttachAdapter
@inject JORequisitionSvcAdapter joRequisitionSvcAdapter
@inject IDivisionSvc divisionSvc
@inject IDepartmentSvc departmentSvc

<PageTitle>Job Order #@Request?.Id</PageTitle>

<BreadcrumbNav>
    <BreadcrumbItem Label="Job Orders" Href="/requests/job-orders" />
    <BreadcrumbItem Label="Details" IsCurrent="true" />
</BreadcrumbNav>

<Confirmation__Modal @ref="confirmModal" />
<EditJORequest__Modal IsModalVisible="@isEditRequestModalVisible" Departments="departments" Divisions="divisions" OnSave="@OnSaveEditReqModal" OnClose="OnCloseEditReqModal" RequestModel="Request ?? new()" IsResubmit="@(Request is not null && Request.Status is RequestStatus.Rejected)" />
<PdfViewer__Modal IsVisible="@isPdfModalVisible"
                  PdfBase64="@pdfBase64"
                  FileName="@($"{Request?.Name}_PR.pdf")"
                  OnClose="@ClosePdfModal" />

<div class="page__container">
    <!-- Left Section - Main Content -->
    <div class="page__left-section">
        <div class="page__left-section-content">

            <!-- Header Section -->
            <div class="details-page__header">
                <div class="details-page__title-section">
                    <h1 class="details-page__title">Job Order #@Request?.SeriesNumber</h1>
                </div>
            </div>

            @if (IsLoading)
            {
                <div class="page__table-loading">
                    <p>Loading request details...</p>
                </div>
            }
            else if (Request == null)
            {
                <div class="error__container">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h3>Request Not Found</h3>
                    <p>The requested job order could not be found.</p>
                    <button class="btn btn--primary" @onclick="NavigateBack">Back to Requests</button>
                </div>
            }
            else
            {
                <div class="tabs">
                    <div class="tabs__header">
                        <button class="tabs__button @(ActiveTab == "details" ? "tabs__button--active" : "")"
                                @onclick="@(() => SetActiveTab("details"))">
                            <i class="bi bi-info-circle"></i>
                            Details
                        </button>
                        <button class="tabs__button @(ActiveTab == "attachments" ? "tabs__button--active" : "")"
                                @onclick="@(() => SetActiveTab("attachments"))">
                            <i class="bi bi-paperclip"></i>
                            Attachments
                            @if (Request.Attachments.Where(e => e.AttachType == RequestAttachType.Request)?.Any() == true)
                            {
                                <span class="tabs__badge">@Request.Attachments.Where(e => e.AttachType == RequestAttachType.Request).Count()</span>
                            }
                        </button>
                        <button class="tabs__button @(ActiveTab == "slips" ? "tabs__button--active" : "")"
                                @onclick="@(() => SetActiveTab("slips"))">
                            <i class="bi bi-file-earmark-text"></i>
                            Requisition Slip
                            @if (Request.RequisitionSlips?.Any() == true)
                            {
                                <span class="tabs__badge">@Request.RequisitionSlips.Count</span>
                            }
                        </button>
                        <button class="tabs__button @(ActiveTab == "approval" ? "tabs__button--active" : "")"
                                @onclick="@(() => SetActiveTab("approval"))">
                            <i class="bi bi-clipboard-check"></i>
                            Approval Process
                        </button>
                        <button class="tabs__button @(ActiveTab == "timeline" ? "tabs__button--active" : "")"
                                @onclick="@(() => SetActiveTab("timeline"))">
                            <i class="bi bi-clock-history"></i>
                            Timeline
                        </button>
                    </div>

                    <div class="tabs__content">
                        @if (ActiveTab == "details")
                        {
                            <RequestDetails__Control Request="Request" ReportType="@ReportType" AwaitingApprovalDate="@awaitingApprovalDate" />
                        }
                        else if (ActiveTab == "slips")
                        {
                            <RequestRequisition__Control Request="Request" AttachSvc="joAttachAdapter" SlipSvc="joRequisitionSvcAdapter" OnRequestChanged="Reload" ConfirmModal="confirmModal" />

                        }
                        else if (ActiveTab == "approval")
                        {
                            <RequestApprovalProcess__Control Request="Request" />
                        }
                        else if (ActiveTab == "attachments")
                        {
                            <RequestAttachments__Control Request="Request" AttachSvc="joAttachAdapter" OnRequestChanged="Reload" AttachType="RequestAttachType.Request" ConfirmModal="confirmModal" ReportType="@ReportType" />
                        }
                        else if (ActiveTab == "timeline")
                        {
                            <RequestTimeline__Control Request="Request" />
                        }
                    </div>
                </div>
            }

        </div>
    </div>

    <!-- Right Section - Actions Sidebar -->
    <div class="page__right-section">
        <div class="details-page__actions">

            @if (CanApproveDeptHead)
            {
                if (!(Request?.Status == RequestStatus.Rejected))
                {
                    <button class="btn btn--success" @onclick="SubmitRequestByDept" title="Submit request">
                        <i class="bi bi-check-lg"></i> Submit
                    </button>
                }
                <button class="btn btn--danger" @onclick="CancelRequestByDept" title="Cancel request">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>

                <hr class="page__hr" />
            }

            @if (CanApproveDivtHead)
            {
                <button class="btn btn--success" @onclick="EndorseRequest" title="Endorse request">
                    <i class="bi bi-check-lg"></i> Endorse
                </button>
                <button class="btn btn--danger" @onclick="RejectEndorseRequest" title="Reject request">
                    <i class="bi bi-x-lg"></i> Reject
                </button>

                <hr class="page__hr" />
            }

            @if (CanApproveAdmin)
            {
                <button class="btn btn--success" @onclick="VerifyByAdminRequest" title="Endorse request">
                    <i class="bi bi-check-lg"></i> Verify
                </button>
                <button class="btn btn--danger" @onclick="RejectVerifyByAdminRequest" title="Reject request">
                    <i class="bi bi-x-lg"></i> Reject
                </button>

                <hr class="page__hr" />
            }

            @if (currentUser.IsCEO && Request?.Status == RequestStatus.ForCeoApproval)
            {
                <button class="btn btn--success" @onclick="ApproveByCeoRequest" title="Approve request">
                    <i class="bi bi-check-lg"></i> Verify
                </button>
                <button class="btn btn--danger" @onclick="RejectByCeoRequest" title="Reject request">
                    <i class="bi bi-x-lg"></i> Reject
                </button>

                <hr class="page__hr" />
            }

            @if (CanClose)
            {
                // if admin unya dili nya under
                if ((currentUser.IsAdmin && Request?.Status == RequestStatus.ForRequisition) && !(Request.UserDepartmentHeadId == currentUser.UserId || Request.ReportToDeptSupId == currentUser.UserId))
                {
                    <button class="btn btn--final" @onclick="RequestClose" title="Close request">
                        <i class="bi bi-lock-fill"></i> Request Closure
                    </button>
                    <hr class="page__hr" />
                }

                //supervisors maka close
                if (Request?.RequestedByDeptHeadId == currentUser.UserId && Request?.Status == RequestStatus.ForRequisition)
                {
                    <button class="btn btn--final" @onclick="ConfirmClose" title="Close request">
                        <i class="bi bi-lock-fill"></i> Close Request
                    </button>
                    <hr class="page__hr" />
                }
            }
            else if (!CanClose && Request?.Status == RequestStatus.ForRequisition)
            {
                // if admin unya dili pa pde i close
                if ((currentUser.IsAdmin && Request?.Status == RequestStatus.ForRequisition) && !(Request.UserDepartmentHeadId == currentUser.UserId || Request.ReportToDeptSupId == currentUser.UserId))
                {
                    <div class="pending-close-banner">
                        <div class="pending-close-banner__info">
                            <div>
                                @if (Request.RequisitionSlips?.Count == 0)
                                {
                                    <strong>Requisition slip required</strong>
                                    <div class="muted">Please add at least one requisition slip before closing.</div>
                                }
                                @if (Request.RequisitionSlips!.Any(e => e.Approval == ApprovalAction.Pending))
                                {
                                    <strong>Approval pending</strong>
                                    <div class="muted">All requisition slips must be approved before closing.</div>
                                }
                                <div class="action-link">
                                    <label style="color: #023b8f;cursor: pointer;margin-top: 4px;" @onclick="@(() => SetActiveTab("slips"))">
                                        Review Requisition Slips
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn--final" @onclick="RequestClose" title="Close request" disabled>
                        <i class="bi bi-lock-fill"></i> Request Closure
                    </button>
                    <hr class="page__hr" />
                }
            }

            @if (Request?.RequestedByDeptHeadId == currentUser.UserId && Request?.Status == RequestStatus.PendingRequesterClosure)
            {
                //pending closure banner
                <div class="pending-close-banner">
                    <div class="pending-close-banner__info">
                        <i class="bi bi-exclamation-circle"></i>
                        <div>
                            <strong>Admin has requested to close this request.</strong>
                            <div class="muted">You have until @((Request?.PendingClosureDate?.AddDays(3))?.ToString("MMM dd, yyyy")) to respond.</div>
                        </div>
                    </div>
                    <div class="pending-close-banner__actions">
                        <button class="btn btn--success" @onclick="ConfirmClose">Confirm Close</button>
                        <button class="btn btn--outline" @onclick="KeepOpen">Keep Open</button>
                    </div>
                </div>
                <hr class="page__hr" />
            }

            @if (CanCEOApproveSlips)
            {
                <div class="pending-close-banner">
                    <div class="pending-close-banner__info">
                        <div>
                            @if (Request!.RequisitionSlips!.Any(e => e.Approval == ApprovalAction.Pending))
                            {
                                <strong>Approval Required</strong>
                                <div class="muted">
                                    @{
                                        var pendingCount = Request.RequisitionSlips!.Count(e => e.Approval == ApprovalAction.Pending);
                                        var slipText = pendingCount == 1 ? "slip" : "slips";
                                    }
                                    You have @pendingCount requisition @slipText awaiting your approval.
                                </div>
                                <div class="action-link">
                                    <label style="color: #023b8f;cursor: pointer;margin-top: 4px;" @onclick="@(() => SetActiveTab("slips"))">
                                        Review Requisition Slips
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            @if (CanEdit)
            {
                <button class="btn btn--secondary" @onclick="NavigateToEdit" title="Edit request">
                    <i class="bi bi-pencil"></i> @EditBtnText
                </button>
            }

            <button class="btn btn--outline" @onclick="ExportToPdf" title="Export to PDF">
                <i class="bi bi-file-earmark-pdf"></i> PDF
            </button>

            <button class="btn btn--ghost" @onclick="NavigateBack" title="Back to main page">
                <i class="bi bi-chevron-left"></i> Back
            </button>
        </div>
    </div>
</div>