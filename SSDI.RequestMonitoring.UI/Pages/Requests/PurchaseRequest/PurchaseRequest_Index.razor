@page "/requests/purchase-requests/"
@using SSDI.RequestMonitoring.UI.Contracts.MasterData
@using SSDI.RequestMonitoring.UI.Contracts.Requests
@using SSDI.RequestMonitoring.UI.Contracts.Requests.Purchase
@using SSDI.RequestMonitoring.UI.Helpers.Export
@using SSDI.RequestMonitoring.UI.JComponents.Cards
@using SSDI.RequestMonitoring.UI.JComponents.Controls
@using SSDI.RequestMonitoring.UI.JComponents.Filters
@using SSDI.RequestMonitoring.UI.JComponents.Modals
@using SSDI.RequestMonitoring.UI.Models.Requests.Purchase
@using SSDI.RequestMonitoring.UI.Pages.Requests.PurchaseRequest.Modals
@inject IPurchaseRequestSvc purchaseRequestSvc
@inject IDivisionSvc divisionSvc
@inject IDepartmentSvc departmentSvc
@inject ExportRequest export
@inject HttpClient Http
@attribute [Authorize]

<PageTitle>Purchase Requests</PageTitle>


<Confirmation__Modal @ref="_confirmModal" />
    <NewRequest__Modal IsModalVisible="@_isNewRequestModalVisible" Departments="@_departments" Divisions="@_divisions" OnSave="@OnSaveNewReqModal" OnClose="@OnCloseNewReqModal" ConfirmModal="@_confirmModal" />


<div class="main--content">
    <div class="page__header">
        <div class="page__title-section">
            <p class="page__header-title">Purchase Requests</p>
            <p class="page__header-subtitle">View and manage purchase requests.</p>
        </div>

        @if (IsShowNewBtn)
        {
            <div class="page__header-cta">
                <button class="page__primary-btn" @onclick="OnAddNewRequest">
                    <i class="bi bi-plus-lg"></i> New Request
                </button>
            </div>
        }
    </div>

    <div class="page__main__section">
        <!-- Metrics Container -->
        <div class="metrics-container">
            <!-- Desktop Grid View -->
            <div class="metrics-grid">
                @foreach (var summary in _statusSummaries)
                {
                    <StatusWBar__Card Label="@summary.Label"
                                      Count="@summary.Count"
                                      TotalCount="@summary.TotalCount"
                                      Icon="@summary.Icon"
                                      OnClick="@(() => OnStatusCardClick(summary.Status))" />
                }
            </div>

            <!-- Mobile Carousel View -->
            <div class="metrics-carousel" @ref="_carouselContainer" @onwheel="HandleWheel">
                <!-- Previous Button (Left side) -->
                <div class="carousel-nav prev">
                    <button class="carousel-btn prev-btn" @onclick="PrevSlide" @attributes="HtmlAttributes.DisabledIf(_currentSlide == 0)" title="Previous">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                </div>

                <!-- Carousel Slides -->
                <div class="carousel-inner" style="transform: translateX(@($"-{_currentSlide * 100}%"));">
                    @foreach (var summary in _statusSummaries)
                    {
                        <div class="carousel-slide">
                            <StatusWBar__Card Label="@summary.Label"
                                              Count="@summary.Count"
                                              TotalCount="@summary.TotalCount"
                                              Icon="@summary.Icon"
                                              OnClick="@(() => OnStatusCardClick(summary.Status))" />
                        </div>
                    }
                </div>

                <!-- Next Button (Right side) -->
                <div class="carousel-nav next">
                    <button class="carousel-btn next-btn" @onclick="NextSlide" @attributes="HtmlAttributes.DisabledIf(_currentSlide == _statusSummaries.Count - 1)" title="Next">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>

                <!-- Slide Indicators (Below the card) -->
                <div class="carousel-indicators">
                    @for (int i = 0; i < _statusSummaries.Count; i++)
                    {
                        <button class="indicator @(i == _currentSlide ? "active" : "")"
                                @onclick="@(() => GoToSlide(i))"
                                aria-label="Go to slide @(i + 1)">
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="page__filters">
            <!-- LEFT FILTERS -->
            <div class="page__filters-left">
                <FluentSearch @bind-Value="@_searchValue"
                              @bind-Value:after="HandleSearch"
                              Immediate="true"
                              Placeholder="Search"
                              Class="page__filters-search" />

                <Status__Filter @ref="_statusFilter" SelectedStatusesChanged="@OnStatusFilterChanged" AnchorId="purchaseRequestStatusFilter" />
                <Priority__Filter @ref="_priorityFilter" SelectedPrioritiesChanged="@OnPriorityFilterChanged" AnchorId="purchaseRequestPriorityFilter" />
                <Clear__Filters OnClear="ClearAllFilters" ButtonText="Clear Filters" />
            </div>

            <!-- RIGHT ACTION -->
            <div class="page__filters-right">
                <DateRange__Filter @ref="_dateRangeFilter"
                                   Position="right"
                                   OnDateRangeChanged="@OnDateRangeChanged"
                                   StartDateChanged="@OnStartDateChanged"
                                   EndDateChanged="@OnEndDateChanged" />

                <button class="page__filters-btn page__export-btn"
                        @attributes="HtmlAttributes.DisabledIf(_filteredItems == null || !_filteredItems.Any())"
                        @onclick="ExportToExcel"
                        title="Export to Excel">
                    <i class="bi bi-file-earmark-excel"></i>
                    <span>Export</span>
                </button>
            </div>
        </div>

        <div class="page__table-container @(uiStateSvc.IsStriped ? "striped-grid" : "")" tabindex="-1">
            @if (_allItems == null || _isLoading)
            {
                <div class="page__table-loading">
                    <p>Loading purchase requests...</p>
                </div>
            }
            else if (_allItems.Count() == 0)
            {
                <div class="page__table-empty">
                    <i class="bi bi-inbox"></i>
                    <p>No purchase requests found</p>
                    <p class="text-muted">Create your first request to get started</p>
                </div>
            }
            else if (_filteredItems?.Count() == 0 && !string.IsNullOrEmpty(_searchValue))
            {
                <div class="sysconfig-empty">
                    <i class="bi bi-search"></i>
                    <h3>No purchase requests found</h3>
                    <p>No purchase requests match your search "<strong>@_searchValue</strong>"</p>
                    <button class="btn btn--ghost" @onclick="ClearSearch">
                        <i class="bi bi-x-lg"></i> Clear Search
                    </button>
                </div>
            }
            else if (_filteredItems?.Count() == 0)
            {
                <div class="sysconfig-empty">
                    <i class="bi bi-search"></i>
                    <h3>No matching purchase requests</h3>
                    <p>No purchase requests match the selected filters</p>
                    <button class="btn btn--ghost" @onclick="ClearAllFilters">
                        <i class="bi bi-x-lg"></i> Clear All Filters
                    </button>
                </div>
            }
            else
            {
                <div class="page__table-wrapper">
                    <FluentDataGrid Class="page__table"
                                    TGridItem="Purchase_RequestVM"
                                    ShowHover="true"
                                    Pagination="@_pagination"
                                    OnRowClick="@OnViewDetails"
                                    GenerateHeader="GenerateHeaderOption.Sticky"
                                    RowSize="DataGridRowSize.Medium"
                                    Items="_filteredItems">
                        <PropertyColumn Title="ID" Property="@(c => c.Id)" Width="100px" Sortable="true" InitialSortDirection="SortDirection.Descending" IsDefaultSortColumn=true />
                        <PropertyColumn Title="Series" Property="@(c => c.SeriesNumber)" Sortable="true" />
                        <PropertyColumn Title="Requested By" Property="@(c => c.Name)" Sortable="true" />
                        <PropertyColumn Title="Nature of Request" Property="@(c => c.Nature_Of_Request)" />
                        <PropertyColumn Title="Division/Department" Property="@(c => c.Division_Department)" />
                        <PropertyColumn Title="Business Unit" Property="@(c => c.BusinessUnitCode)" />
                        <TemplateColumn Title="Requested On" Width="140px" Sortable="true">
                            <div class="page__table-date">
                                <span class="page__table-date-main">
                                    @context.DateRequested?.ToString("MMM dd, yyyy")
                                </span>
                                <span class="page__table-date-relative">
                                    @(Utils.GetRelativeTime(context.DateRequested))
                                </span>
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Priority" Align="Align.Center">
                            <div class="page__table-priority">
                                <div class="priority-dot" data-prio="@context.Priority"></div>
                                <span>@(Utils.GetPriorityDisplay(context.Priority, context.OtherPriority, true))</span>
                            </div>
                        </TemplateColumn>
                        <TemplateColumn Title="Status" Align="Align.Center" Sortable="true" SortBy="_sortStatus">
                            <div class="page__table-status" data-status="@context.Status">
                                <i class="@Utils.GetStatusIcon(context.Status)"></i>
                                <span class="page__table-status-text">@Utils.GetStatusDisplay(context.Status)</span>
                            </div>
                        </TemplateColumn>
                        @* <TemplateColumn Title="Actions" Width="140px" Align="Align.Center">
                        <div class="page__table-actions">
                            <button type="button" @onclick="(() => OnEditRequest(context))"
                                    class="page__table-action-btn page__table-edit-btn"
                                    title="Edit request">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button type="button" @onclick="(() => OnDeleteRequest(context.Id))"
                                    class="page__table-action-btn page__table-delete-btn"
                                    title="Delete request">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </TemplateColumn> *@
                    </FluentDataGrid>
                </div>

                <Pagination__Control Pagination="@_pagination" PageSizeChanged="@OnPageSizeChanged" IsStripedChanged="@(() => StateHasChanged())" />
            }
        </div>
    </div>

</div>