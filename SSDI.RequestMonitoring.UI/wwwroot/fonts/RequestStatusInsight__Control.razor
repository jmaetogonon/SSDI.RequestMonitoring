@using SSDI.RequestMonitoring.UI.Models.Enums
@using SSDI.RequestMonitoring.UI.Models.Common

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="request-status-insight @CssClass">
        <i class="bi @Icon"></i>
        <span>@Message</span>
    </div>
}

@code {
    [Parameter] public IRequestDetailVM Request { get; set; } = default!;
    [Parameter] public string ReportType { get; set; } = "Unknown";
    [Parameter] public DateTime? AwaitingApprovalDate { get; set; }

    private string Message = string.Empty;
    private string CssClass = "info";
    private string Icon = "bi-info-circle";

    protected override void OnParametersSet()
    {
        BuildMessage();
    }

    private void BuildMessage()
    {
        if (Request == null) return;

        // ============================
        // CLOSED REQUEST
        // ============================
        if (Request.Status == RequestStatus.Closed && Request.DateCompleted.HasValue)
        {
            var duration = Request.DateCompleted.Value - Request.DateCreated;

            Message =
                $"This request was completed in {FormatDuration(duration)} " +
                $"on {Request.DateCompleted.Value:MMM dd, yyyy}.";

            CssClass = "success";
            Icon = "bi-check-circle";
            return;
        }


        // ============================
        // CANCELLED
        // ============================
        if (Request.Status == RequestStatus.Cancelled)
        {
            var action = Request.ApprovalsBase
                .Where(a => a.Action == ApprovalAction.Cancel && a.ActionDate.HasValue)
                .OrderByDescending(a => a.ActionDate)
                .FirstOrDefault();

            if (action?.ActionDate != null)
            {
                var duration = action.ActionDate.Value - Request.DateCreated;

                Message =
                    $"This request was cancelled in {FormatDuration(duration)} " +
                    $"on {action.ActionDate.Value:MMM dd, yyyy}.";
            }
            else
            {
                Message = "This request was cancelled.";
            }

            CssClass = "muted";
            Icon = "bi-x-circle";
            return;
        }


        // ============================
        // AWAITING APPROVAL
        // ============================
        if (AwaitingApprovalDate.HasValue)
        {
            var duration = DateTime.Now - AwaitingApprovalDate.Value;

            Message = $"{FormatDuration(duration)} pending since you were required to approve this request.";
            if (Request.Status == RequestStatus.Rejected) Message = $"Rejected {FormatDuration(duration)} ago.";
            CssClass = GetSeverity(duration);
            Icon = "bi-hourglass-split";
            return;
        }

        // ============================
        // PENDING APPROVAL
        // ============================
        var pendingSince = CalculatePendingSince();

        if (pendingSince.HasValue)
        {
            var duration = DateTime.Now - pendingSince.Value;

            if (currentUser.IsUser || Request?.RequestedById == currentUser.UserId)
            {
                Message = $"In progress for {FormatDuration(duration)} since your submission.";
            }
            else
            {
                Message = $"In progress for {FormatDuration(duration)} since your approval.";
            }
            CssClass = GetSeverity(duration);
            Icon = "bi-hourglass-split";

            return;
        } 
    }

    // ============================
    // HELPERS
    // ============================
    private static string FormatDaysAgo(DateTime date)
    {
        var days = (DateTime.Now.Date - date.Date).Days;

        if (days <= 0) return "today";
        if (days == 1) return "yesterday";
        if (days <= 7) return $"{days} days ago";
        if (days <= 30) return $"{days / 7} weeks ago";
        if (days <= 365) return $"{days / 30} months ago";
        return $"{days / 365} years ago";
    }

    private static string FormatDuration(TimeSpan? span)
    {
        if (span!.Value.TotalSeconds < 60)
            return $"{Math.Floor(span!.Value.TotalSeconds)} second{Plural(span!.Value.TotalSeconds)}";

        if (span!.Value.TotalMinutes < 60)
            return $"{Math.Floor(span!.Value.TotalMinutes)} minute{Plural(span!.Value.TotalMinutes)}";

        if (span!.Value.TotalHours < 24)
            return $"{Math.Floor(span!.Value.TotalHours)} hour{Plural(span!.Value.TotalHours)}";

        return $"{Math.Floor(span!.Value.TotalDays)} day{Plural(span!.Value.TotalDays)}";
    }

    private static string Plural(double value)
        => Math.Floor(value) == 1 ? "" : "s";

    private static string GetSeverity(TimeSpan span)
    {
        if (span.TotalDays >= 7) return "danger";
        if (span.TotalDays >= 3) return "warning";
        return "info";
    }

    private DateTime? CalculatePendingSince()
    {
        var approvals = Request?.ApprovalsBase.ToList();

        if (Request?.RequestedById == currentUser.UserId)
            return Request.DateCreated;

        var approvalStage = DetermineApprovalStage();
        return Request?.ApprovalsBase?
            .Where(a => a.Stage == approvalStage && a.Action == ApprovalAction.Approve)
            .LastOrDefault()?
            .ActionDate;
    }

    private ApprovalStage? DetermineApprovalStage()
    {
        ApprovalStage? approval = null;
        if (ReportType == "Department")
            approval = ApprovalStage.DepartmentHead;

        if (ReportType == "Division" ||
            (Request?.UserDivisionHeadId == currentUser.UserId &&
             Request?.Status > RequestStatus.ForEndorsement))
            approval = ApprovalStage.DivisionHead;

        if (currentUser.IsCEO)
        {
            if (Request?.Status > RequestStatus.ForCeoApproval)
                approval = ApprovalStage.CeoOrAvp;
        }

        if (currentUser.IsAdmin & Request?.Status > RequestStatus.ForAdminVerification)
            approval = ApprovalStage.Admin;

        return approval;
    }
}
